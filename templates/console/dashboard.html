{% extends 'console/base.html' %}
{% load humanize %}
{% block console_content %}
<section class="console-page-header">
    <div class="console-hero">
        <div class="hero-content">
            <p class="eyebrow">Assessment console</p>
            <h1>Superadmin overview</h1>
            <p class="lede">Monitor assessment throughput, client onboarding, and workspace activity.</p>
        </div>
        <div class="hero-highlight">
            <div>
                <p>Total assessments</p>
                <strong>{{ summary_cards|length }}</strong>
            </div>
            <div>
                <p>Clients</p>
                <strong>{{ org_summary.clients.total }}</strong>
            </div>
            <div>
                <p>Users</p>
                <strong>{{ org_summary.users.total }}</strong>
            </div>
        </div>
    </div>
</section>

<section class="panel-grid metric-grid metric-cluster">
    <article class="panel metric-panel accent-clients">
        <div class="metric-panel-inner">
            <div class="metric-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" role="presentation" focusable="false">
                    <path d="M5 21V5a2 2 0 0 1 2-2h3v6h4V3h3a2 2 0 0 1 2 2v16m-14 0h14M9 12h1m0 4H9m5-4h1m0 4h-1"
                        fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
            </div>
            <div>
                <p class="metric-label">Client accounts</p>
                <div class="metric-value">{{ org_summary.clients.total }}</div>
                <ul class="metric-breakdown">
                    <li>
                        <span>Approved</span>
                        <strong>{{ org_summary.clients.approved }}</strong>
                    </li>
                    <li>
                        <span>Pending</span>
                        <strong>{{ org_summary.clients.pending }}</strong>
                    </li>
                </ul>
            </div>
        </div>
    </article>
    <article class="panel metric-panel accent-users">
        <div class="metric-panel-inner">
            <div class="metric-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" role="presentation" focusable="false">
                    <path d="M12 13.5c-2.9 0-5.25 2.35-5.25 5.25V21h10.5v-2.25c0-2.9-2.35-5.25-5.25-5.25Zm0-2.25A3.75 3.75 0 1 0 12 3.75a3.75 3.75 0 0 0 0 7.5Z"
                        fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
            </div>
            <div>
                <p class="metric-label">Console users</p>
                <div class="metric-value">{{ org_summary.users.total }}</div>
                <p class="metric-helper">Internal reviewers, partners, and client admins.</p>
            </div>
        </div>
    </article>
    <article class="panel metric-panel quick-links-panel neutral">
        <div class="metric-panel-inner">
            <div class="metric-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" role="presentation" focusable="false">
                    <path d="M7 12h10m-5-5 5 5-5 5" fill="none" stroke="currentColor" stroke-width="1.5"
                        stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </div>
            <div>
                <p class="metric-label">Quick links</p>
                <p class="metric-helper">Jump into the most common console workflows.</p>
                {% if quick_links %}
                <div class="chip-row">
                    {% for link in quick_links %}
                    <a class="chip" href="{{ link.href }}">{{ link.label }}</a>
                    {% endfor %}
                </div>
                {% else %}
                <p class="muted">No shortcuts available.</p>
                {% endif %}
            </div>
        </div>
    </article>
</section>

<section class="stats-grid three-up assessment-grid">
    {% for card in summary_cards %}
    <article class="assessment-stat-card theme-{{ card.label|slugify }}">
        <header class="assessment-card-header">
            <div class="assessment-icon" aria-hidden="true">
                <span>{{ card.label|slice:":1" }}</span>
            </div>
            <div class="assessment-heading">
                <p class="label">Assessment</p>
                <h3>{{ card.label }}</h3>
            </div>
            <span class="micro-pill">{{ card.in_progress }} active</span>
        </header>
        <div class="stat-total">
            {{ card.total }}
            <span>Total sessions</span>
        </div>
        <div class="progress-row" aria-label="Completion progress">
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ card.completion_pct }}%;"></div>
            </div>
            <span class="progress-label">{{ card.completion_pct }}% completed</span>
        </div>
        <dl class="stat-breakdown">
            <div>
                <dt>In progress</dt>
                <dd>{{ card.in_progress }}</dd>
            </div>
            <div>
                <dt>Completed</dt>
                <dd>{{ card.completed }}</dd>
            </div>
        </dl>
        <div class="card-actions">
            <a class="pill subtle" href="{{ card.detail_url }}">View sessions</a>
        </div>
    </article>
    {% endfor %}
</section>

{% if reporting %}
<section class="report-card-grid two-up">
    <article class="report-card chart-card">
        <p class="label">Assessment mix</p>
        <h2>Invites vs. in progress</h2>
        <canvas id="assessmentMixChart"></canvas>
    </article>
    <article class="report-card chart-card">
        <p class="label">7-day timeline</p>
        <h2>Sessions created</h2>
        <canvas id="timelineChart"></canvas>
    </article>
</section>
{% endif %}

<section class="panel">
    <header>
        <h2>Pending client approvals</h2>
        <a href="{% url 'console:client-list' %}?status=pending">View all</a>
    </header>
    {% if pending_clients %}
    <div class="table">
        <div class="table-row table-head">
            <span>Company</span>
            <span>Contact</span>
            <span>Requested</span>
            <span>Submitted</span>
        </div>
        {% for client in pending_clients %}
        <div class="table-row">
            <span>{{ client.company_name }}</span>
            <span>{{ client.email }}</span>
            <span>{{ client.requested_assessments|join:", "|title }}</span>
            <span>{{ client.created_at|naturaltime }}</span>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="empty-state">No pending requests.</p>
    {% endif %}
</section>

<section class="panel">
    <header>
        <h2>Latest activity</h2>
    </header>
    {% if recent_sessions %}
    <div class="table">
        <div class="table-row table-head">
            <span>Candidate</span>
            <span>Assessment</span>
            <span>Status</span>
            <span>Updated</span>
            <span></span>
        </div>
        {% for entry in recent_sessions %}
        <div class="table-row">
            <span>{{ entry.candidate }}</span>
            <span>{{ entry.label }}</span>
            <span>{{ entry.status }}</span>
            <span>{{ entry.timestamp|naturaltime }}</span>
            <span><a class="pill subtle" href="{{ entry.url }}">Open</a></span>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="empty-state">No activity yet.</p>
    {% endif %}
</section>

{% if reporting %}
{{ reporting.charts|json_script:"dashboard-report-data" }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
(function () {
    const payload = JSON.parse(document.getElementById("dashboard-report-data").textContent);
    const mixCanvas = document.getElementById("assessmentMixChart");
    const timelineCanvas = document.getElementById("timelineChart");

    if (mixCanvas) {
        const mix = payload.assessment_mix || [];
        new Chart(mixCanvas, {
            type: "bar",
            data: {
                labels: mix.map((m) => m.label),
                datasets: [
                    {
                        label: "Total sessions",
                        data: mix.map((m) => m.total),
                        backgroundColor: "rgba(255,138,0,0.4)",
                        borderRadius: 12,
                    },
                    {
                        label: "In progress",
                        data: mix.map((m) => m.in_progress),
                        backgroundColor: "rgba(14,20,40,0.85)",
                        borderRadius: 12,
                    },
                ],
            },
            options: {
                responsive: true,
                plugins: { legend: { position: "bottom" } },
                scales: { y: { beginAtZero: true } },
            },
        });
    }

    if (timelineCanvas) {
        const timeline = payload.timeline || [];
        new Chart(timelineCanvas, {
            type: "line",
            data: {
                labels: timeline.map((t) => t.label),
                datasets: [
                    {
                        label: "Sessions",
                        data: timeline.map((t) => t.count),
                        borderColor: "rgba(14,20,40,0.85)",
                        backgroundColor: "rgba(14,20,40,0.15)",
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                    },
                ],
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } },
            },
        });
    }
})();
</script>
{% endif %}
{% endblock %}
