{% extends 'console/base.html' %}
{% load humanize %}
{% block console_content %}
<section class="console-page-header">
    <div>
        <p class="eyebrow">Candidate</p>
        <h1>{{ candidate.first_name }} {{ candidate.last_name }}</h1>
        <p class="lede">{{ candidate.email }}</p>
    </div>
    <div class="header-actions">
        <a class="btn btn-outline" href="mailto:{{ candidate.email }}">Email</a>
    </div>
</section>

<section class="panel meta-panel">
    <dl>
        <div>
            <dt>Company</dt>
            <dd>{{ candidate.metadata.company|default:"—" }}</dd>
        </div>
        <div>
            <dt>Headline</dt>
            <dd>{{ candidate.headline|default:"—" }}</dd>
        </div>
        <div>
            <dt>Joined</dt>
            <dd>{{ candidate.created_at|date:"M d, Y" }}</dd>
        </div>
    </dl>
</section>

{% for session, form in session_forms %}
<section class="panel session-panel">
    <header>
        <div>
            <p class="eyebrow">{{ session.assessment.category.name }}</p>
            <h2>{{ session.assessment.title }}</h2>
        </div>
        <div class="session-actions">
            <span class="pill subtle">{{ session.status|title }}</span>
            <a class="pill subtle" href="{% url 'console:session-detail' session.pk %}">View results</a>
        </div>
    </header>
    <p class="session-meta">
        {% if session.position_task %}
            Task · {{ session.position_task.title }}
        {% else %}
            Task · Not assigned
        {% endif %}
        {% if session.company %}
            · Company · {{ session.company.name }}
        {% endif %}
        · Focus · {{ session.behavioral_focus_display }}
        · Invited {{ session.invited_at|naturaltime }} · Due
        {% if session.due_at %}{{ session.due_at|naturaltime }}{% else %}Not set{% endif %}
        · Score
        {% if session.overall_score != None %}
        {{ session.overall_score|floatformat:0 }}%
        {% else %}
        Pending
        {% endif %}
        · Decision {{ session.get_decision_display }}
    </p>
    {% with behavior=session.score_breakdown.behavioral_profile %}
    {% if behavior %}
    <div class="behavior-preview">
        <div class="behavior-row">
            <div>
                <p class="eyebrow">Dominant traits</p>
                <p class="lede small">
                    {% if behavior.dominant_traits %}
                        {{ behavior.dominant_traits|join:", " }}
                    {% else %}
                        Emerging
                    {% endif %}
                </p>
            </div>
            <div>
                <p class="eyebrow">Behavioral eligibility</p>
                <p class="lede small">
                    {{ behavior.eligibility.decision|default:"Not evaluated"|title }}
                    {% if behavior.eligibility.score != None %}
                    · {{ behavior.eligibility.score|floatformat:0 }}%
                    {% endif %}
                </p>
            </div>
            <div>
                {% with report=behavior.red_flag_report %}
                <p class="eyebrow">Risk level</p>
                <p class="lede small {{ report.overall_risk_level|default:"" }}">
                    {{ report.overall_risk_level|default:"Low"|title|default:"Low" }}
                    {% if report.red_flags %}
                    · {{ report.red_flags|length }} flag{% if report.red_flags|length > 1 %}s{% endif %}
                    {% else %}
                    · No flags
                    {% endif %}
                </p>
                {% endwith %}
            </div>
        </div>
        <div class="behavior-row">
            <p class="behavior-note">
                {{ behavior.candidate_summary.eligibility_message|default:"Behavioral summary available in session view." }}
            </p>
            <a class="pill subtle" href="{% url 'console:session-detail' session.pk %}">View behavioral summary</a>
        </div>
    </div>
    {% endif %}
    {% endwith %}
    <form method="post" class="form-stack">
        {% csrf_token %}
        <input type="hidden" name="session_id" value="{{ session.pk }}">
        {% for field in form %}
        <div class="form-field">
            {{ field.label_tag }}
            {{ field }}
            {% for error in field.errors %}
            <span class="field-error">{{ error }}</span>
            {% endfor %}
        </div>
        {% endfor %}
        <button class="btn btn-pill">Save updates</button>
    </form>
</section>
{% empty %}
<p class="empty-state">No sessions yet.</p>
{% endfor %}
{% endblock %}
