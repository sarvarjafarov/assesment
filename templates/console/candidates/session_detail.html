{% extends 'console/base.html' %}
{% load humanize %}
{% block console_content %}
<section class="console-page-header">
    <div>
        <p class="eyebrow">Candidate Result</p>
        <h1>{{ candidate.first_name }} {{ candidate.last_name }}</h1>
        <p class="lede">{{ assessment.title }} · {{ assessment.category.name }}</p>
    </div>
    <div class="header-actions">
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="quick_decision" value="advance" />
            <button class="btn btn-pill" type="submit">Mark as shortlisted</button>
        </form>
        <a class="btn btn-outline" href="{% url 'console:candidate-detail' candidate.pk %}">Back to candidate</a>
    </div>
</section>

<section class="panel metric-panel">
    <div class="metric-grid">
        <article class="metric-card">
            <p class="metric-label">Status</p>
            <p class="metric-value">{{ session_obj.get_status_display }}</p>
        </article>
        <article class="metric-card">
            <p class="metric-label">Decision</p>
            <p class="metric-value decision {{ session_obj.decision }}">{{ session_obj.get_decision_display }}</p>
        </article>
        <article class="metric-card">
            <p class="metric-label">Score</p>
            <p class="metric-value">
                {% if session_obj.overall_score != None %}
                {{ session_obj.overall_score|floatformat:0 }}%
                {% else %}
                —
                {% endif %}
            </p>
        </article>
        <article class="metric-card">
            <p class="metric-label">Auto decision</p>
            <p class="metric-value decision {{ session_obj.score_breakdown.auto_decision|default:'' }}">
                {{ session_obj.score_breakdown.auto_decision|default:"—"|title }}
            </p>
        </article>
        <article class="metric-card">
            <p class="metric-label">Due</p>
            <p class="metric-value">{% if session_obj.due_at %}{{ session_obj.due_at|naturaltime }}{% else %}Flexible{% endif %}</p>
        </article>
    </div>
</section>

<section class="panel response-panel">
    <header>
        <h2>Responses</h2>
        <small>Submitted {{ session_obj.submitted_at|naturaltime|default:"Not yet" }}</small>
    </header>
    {% if responses %}
    <ol class="question-list">
        {% for response in responses %}
        <li>
            <p class="question-title">{{ response.question.prompt }}</p>
            {% if response.selected_choices.all %}
            <ul class="choice-list">
                {% for choice in response.selected_choices.all %}
                <li>{{ choice.label }}</li>
                {% endfor %}
            </ul>
            {% else %}
            <p>{{ response.answer_text|default:"—" }}</p>
            {% endif %}
            {% if response.score %}
            <small>Score: {{ response.score }}</small>
            {% endif %}
        </li>
        {% endfor %}
    </ol>
    {% else %}
    <p class="empty-state">Responses will appear once the candidate submits.</p>
    {% endif %}
</section>

{% if session_obj.score_breakdown.question_scores %}
<section class="panel">
    <header>
        <h2>Question scores</h2>
    </header>
    <div class="table">
        <div class="table-row table-head">
            <span>Question</span>
            <span>Score</span>
        </div>
        {% for item in session_obj.score_breakdown.question_scores %}
        <div class="table-row">
            <span>{{ item.prompt }}</span>
            <span>{{ item.score }}%</span>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

<section class="panel">
    <header>
        <h2>Update status</h2>
    </header>
    <form method="post" class="form-stack">
        {% csrf_token %}
        {% if form.non_field_errors %}
        <div class="form-error">
            {% for error in form.non_field_errors %}
            <p>{{ error }}</p>
            {% endfor %}
        </div>
        {% endif %}
        {% for field in form %}
        <div class="form-field">
            {{ field.label_tag }}
            {{ field }}
            {% for error in field.errors %}
            <span class="field-error">{{ error }}</span>
            {% endfor %}
        </div>
        {% endfor %}
        <button class="btn btn-pill" type="submit">Save updates</button>
    </form>
</section>
{% endblock %}
