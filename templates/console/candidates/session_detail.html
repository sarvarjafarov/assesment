{% extends 'console/base.html' %}
{% load humanize dict_extras %}
{% block console_content %}
<section class="console-page-header">
    <div>
        <p class="eyebrow">Candidate Result</p>
        <h1>{{ candidate.first_name }} {{ candidate.last_name }}</h1>
        <p class="lede">{{ assessment.title }} · {{ assessment.category.name }}</p>
    </div>
    <div class="header-actions">
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="quick_decision" value="advance" />
            <button class="btn btn-pill" type="submit">Mark as shortlisted</button>
        </form>
        <a class="btn btn-outline" href="{% url 'console:candidate-detail' candidate.pk %}">Back to candidate</a>
    </div>
</section>

{% with behavior=session_obj.score_breakdown.behavioral_profile %}
<section class="panel metric-panel">
    <div class="metric-grid">
        <article class="metric-card">
            <p class="metric-label">Status</p>
            <p class="metric-value">{{ session_obj.get_status_display }}</p>
        </article>
        <article class="metric-card">
            <p class="metric-label">Decision</p>
            <p class="metric-value decision {{ session_obj.decision }}">{{ session_obj.get_decision_display }}</p>
        </article>
        <article class="metric-card">
            <p class="metric-label">Score</p>
            <p class="metric-value">
                {% if session_obj.overall_score != None %}
                {{ session_obj.overall_score|floatformat:0 }}%
                {% elif behavior %}
                {{ behavior.eligibility.score|floatformat:0 }}%
                {% else %}
                —
                {% endif %}
            </p>
        </article>
        <article class="metric-card">
            <p class="metric-label">Auto decision</p>
            {% with auto=session_obj.score_breakdown.auto_decision %}
            <p class="metric-value decision {{ auto|default:'' }}">
                {% if auto %}
                {{ auto|title }}
                {% elif behavior %}
                {{ behavior.eligibility.decision|title }}
                {% else %}
                —
                {% endif %}
            </p>
            {% endwith %}
        </article>
        <article class="metric-card">
            <p class="metric-label">Due</p>
            <p class="metric-value">{% if session_obj.due_at %}{{ session_obj.due_at|naturaltime }}{% else %}Flexible{% endif %}</p>
        </article>
    </div>
</section>
{% endwith %}

{% with behavior=session_obj.score_breakdown.behavioral_profile %}
{% if behavior %}
<section class="panel behavior-panel">
    <header>
        <div>
            <p class="eyebrow">Behavioral profile</p>
            <h2>Behavioral readiness snapshot</h2>
            <p class="lede small">{{ behavior.candidate_summary.intro }}</p>
        </div>
        <div class="behavior-stat">
            {% with report=behavior.red_flag_report %}
            <span class="pill subtle {{ report.overall_risk_level|default:'' }}">
                Risk: {{ report.overall_risk_level|default:"low"|title }}
            </span>
            {% endwith %}
        </div>
    </header>
    <div class="behavior-grid">
        <article class="behavior-card">
            <p class="card-label">Eligibility</p>
            <h3 class="card-value">{{ behavior.eligibility.decision|title }}</h3>
            <p class="card-metric">
                <span>{{ behavior.eligibility.score|floatformat:0 }}%</span>
                <small>weighted score</small>
            </p>
            <p>{{ behavior.candidate_summary.eligibility_message }}</p>
        </article>
        <article class="behavior-card">
            <p class="card-label">Dominant traits</p>
            <ul class="chip-list">
                {% if behavior.dominant_traits %}
                    {% for trait in behavior.dominant_traits %}
                        <li class="chip">{{ trait|title }}</li>
                    {% endfor %}
                {% else %}
                    <li class="chip">Emerging</li>
                {% endif %}
            </ul>
            <p class="muted">Development focus:
                {% if behavior.development_traits %}
                    {{ behavior.development_traits|join:", " }}
                {% else %}
                    None flagged
                {% endif %}
            </p>
        </article>
        <article class="behavior-card">
            <p class="card-label">Coverage</p>
            <p class="card-value">{{ behavior.coverage_score|floatformat:0 }}</p>
            <p class="muted">Traits covered of {{ behavior.trait_counts|length }}</p>
            <p class="muted">Balance gap: {{ behavior.balance_gap|floatformat:0 }} pts</p>
        </article>
    </div>
    <div class="behavior-split">
        {% with summary=behavior.candidate_summary %}
        <div class="behavior-summary">
            {% for trait, data in summary.traits.items %}
            <article>
                <p class="eyebrow">{{ trait|title }}</p>
                <p class="trait-label">{{ data.label }}</p>
                <p class="muted">{{ data.description }}</p>
            </article>
            {% endfor %}
        </div>
        {% endwith %}
        <div class="table trait-table">
            <div class="table-row table-head">
                <span>Trait</span>
                <span>Score</span>
                <span>Label</span>
            </div>
            {% for item in behavior.trait_rankings %}
            <div class="table-row">
                <span>{{ item.trait|title }}</span>
                <span>
                    {% if item.normalized_score != None %}
                        {{ item.normalized_score|floatformat:0 }}%
                    {% else %}
                        —
                    {% endif %}
                </span>
                <span>{{ behavior.behavior_labels|dict_get:item.trait|default:"—" }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% with report=behavior.red_flag_report %}
    <div class="behavior-risks">
        <h3>Risk alerts</h3>
        {% if report.red_flags %}
        <ul class="flag-list">
            {% for flag in report.red_flags %}
            <li>
                <strong>{{ flag.code|humanize_flag }}</strong>
                · {{ flag.level|title }}
                <p>{{ flag.explanation|default:flag.reason }}</p>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="empty-state">No red flags detected.</p>
        {% endif %}
        {% if report.follow_up_questions %}
        <div class="follow-up">
            <h4>Suggested follow-up</h4>
            {% for bundle in report.follow_up_questions %}
            <article>
                <p class="eyebrow">{{ bundle.title }}</p>
                <ul class="bullet">
                    {% for question in bundle.questions %}
                    <li>{{ question }}</li>
                    {% endfor %}
                </ul>
                {% if bundle.probing_questions %}
                <p><strong>Probing:</strong></p>
                <ul class="bullet">
                    {% for question in bundle.probing_questions %}
                    <li>{{ question }}</li>
                    {% endfor %}
                </ul>
                {% endif %}
                {% if bundle.red_flag_indicators %}
                <p><strong>Watch for:</strong> {{ bundle.red_flag_indicators|join:", " }}</p>
                {% endif %}
            </article>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    {% endwith %}
</section>
{% endif %}
{% endwith %}

<section class="panel response-panel">
    <header>
        <h2>Responses</h2>
        <small>Submitted {{ session_obj.submitted_at|naturaltime|default:"Not yet" }}</small>
    </header>
    {% if responses %}
    <ol class="question-list">
        {% for response in responses %}
        <li>
            <p class="question-title">{{ response.question.prompt }}</p>
            {% if response.question.question_type == 'behavioral' and response.behavioral_entries %}
            <table class="behavioral-response-table">
                <thead>
                    <tr>
                        <th>Statement</th>
                        <th>Trait</th>
                        <th>Selection</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in response.behavioral_entries %}
                    <tr>
                        <td><strong>{{ entry.statement_id }}</strong> {{ entry.text }}</td>
                        <td>{{ entry.trait|default:"—" }}</td>
                        <td>{{ entry.response_type|replace:"_"," "|title }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% elif response.selected_choices.all %}
            <ul class="choice-list">
                {% for choice in response.selected_choices.all %}
                <li>{{ choice.label }}</li>
                {% endfor %}
            </ul>
            {% else %}
            <p>{{ response.answer_text|default:"—" }}</p>
            {% endif %}
            {% if response.score %}
            <small>Score: {{ response.score }}</small>
            {% endif %}
        </li>
        {% endfor %}
    </ol>
    {% else %}
    <p class="empty-state">Responses will appear once the candidate submits.</p>
    {% endif %}
</section>

{% if session_obj.score_breakdown.question_scores %}
<section class="panel">
    <header>
        <h2>Question scores</h2>
    </header>
    <div class="table">
        <div class="table-row table-head">
            <span>Question</span>
            <span>Score</span>
        </div>
        {% for item in session_obj.score_breakdown.question_scores %}
        <div class="table-row">
            <span>{{ item.prompt }}</span>
            <span>{{ item.score }}%</span>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

<section class="panel">
    <header>
        <h2>Update status</h2>
    </header>
    <form method="post" class="form-stack">
        {% csrf_token %}
        {% if form.non_field_errors %}
        <div class="form-error">
            {% for error in form.non_field_errors %}
            <p>{{ error }}</p>
            {% endfor %}
        </div>
        {% endif %}
        {% for field in form %}
        <div class="form-field">
            {{ field.label_tag }}
            {{ field }}
            {% for error in field.errors %}
            <span class="field-error">{{ error }}</span>
            {% endfor %}
        </div>
        {% endfor %}
        <button class="btn btn-pill" type="submit">Save updates</button>
    </form>
</section>
{% endblock %}
