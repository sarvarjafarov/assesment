{% extends 'portal_base.html' %}
{% load static %}
{% load humanize %}
{% block title %}Candidates Â· Evalon{% endblock %}
{% block meta_description %}Review candidate applications across all positions.{% endblock %}
{% block portal_content %}
<div class="portal-shell">

    <header class="ap-header">
        <div>
            <h1>Candidates</h1>
            <p class="muted">Review candidate applications across all positions</p>
        </div>
    </header>

    <div class="ap-filters">
        <form method="get" class="ap-filter-form">
            <select name="position" class="ap-filter-select">
                <option value="">All positions</option>
                {% for project in projects %}
                <option value="{{ project.uuid }}" {% if selected_position == project.uuid|stringformat:"s" %}selected{% endif %}>{{ project.title }}</option>
                {% endfor %}
            </select>
            <select name="status" class="ap-filter-select">
                <option value="">All statuses</option>
                {% for code, label in status_choices %}
                <option value="{{ code }}" {% if selected_status == code %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
            {% if can_use_ai_hiring %}
            <select name="ai" class="ap-filter-select">
                <option value="">AI: All</option>
                <option value="screened" {% if selected_ai == "screened" %}selected{% endif %}>AI Screened</option>
                <option value="passed" {% if selected_ai == "passed" %}selected{% endif %}>AI Passed</option>
                <option value="failed" {% if selected_ai == "failed" %}selected{% endif %}>AI Failed</option>
            </select>
            {% endif %}
            <button type="submit" class="btn btn-outline small">Filter</button>
        </form>
    </div>

    {% if applications %}
    <div class="ap-table-wrap">
        <table class="ap-table">
            <thead>
                <tr>
                    <th>Candidate</th>
                    <th>Position</th>
                    <th>Status</th>
                    {% if can_use_ai_hiring %}<th>AI Score</th>{% endif %}
                    <th>Applied</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for app in applications %}
                <tr class="ap-row">
                    <td>
                        <span class="ap-name">{{ app.full_name }}</span>
                        <span class="ap-email">{{ app.email }}</span>
                    </td>
                    <td>{{ app.project.title }}</td>
                    <td><span class="ap-status ap-status-{{ app.status }}">{{ app.get_status_display }}</span></td>
                    {% if can_use_ai_hiring %}
                    <td>
                        {% if app.pipeline_candidate and app.pipeline_candidate.ai_screen_score is not None %}
                        <span class="ap-ai-score {% if app.pipeline_candidate.ai_screen_score >= 60 %}ap-ai-score-pass{% else %}ap-ai-score-fail{% endif %}">{{ app.pipeline_candidate.ai_screen_score|floatformat:0 }}</span>
                        {% else %}
                        <span class="ap-cell-muted">&mdash;</span>
                        {% endif %}
                    </td>
                    {% endif %}
                    <td class="ap-cell-muted">{{ app.created_at|naturaltime }}</td>
                    <td class="ap-cell-action">
                        <a href="{% url 'clients:application-detail' application_uuid=app.uuid %}" class="ap-view-link">View &rarr;</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="ap-empty">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.2; color: var(--color-orange); margin-bottom: 1rem;">
            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
            <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
        </svg>
        <h3>No candidates yet</h3>
        <p class="muted">Candidates will appear here when they apply through your vacancy page or when you send assessment invites directly.</p>
        <div class="ap-empty-actions">
            {% if vacancy_page_url %}
            <a href="{{ vacancy_page_url }}" target="_blank" class="btn btn-outline small">View Vacancy Page</a>
            {% endif %}
            <a href="{% url 'clients:project-create' %}" class="btn btn-primary small">Create Position</a>
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}
