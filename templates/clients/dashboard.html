{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block content %}
<div class="portal-shell">
    <header class="portal-hero expanded">
        <div class="portal-hero-main">
            <div class="portal-hero-icon{% if account.has_logo %} logo{% endif %}">
                {% if account.logo_data_url %}
                <img src="{{ account.logo_data_url }}" alt="{{ account.company_name }} logo">
                {% else %}
                <span>⚡</span>
                {% endif %}
                {% if can_manage_branding or is_manager %}
                <button class="logo-edit-trigger" type="button" aria-label="Change logo" data-logo-edit-trigger>
                    ✏️
                </button>
                {% endif %}
            </div>
            <div>
                <p class="eyebrow">Client workspace</p>
                <h1>{{ account.company_name }}</h1>
                <p class="lede">Access to {{ allowed_assessments|length }} assessment{{ allowed_assessments|pluralize }} · {{ account.get_employee_size_display }} org size · {{ role_label }} role</p>
            </div>
        </div>
        <div class="portal-hero-stats">
            <div>
                <p class="hero-stat-label">Completion rate</p>
                <p class="hero-stat-value">{{ portal_stats.completion_rate|floatformat:0 }}%</p>
                <p class="hero-stat-helper">{{ portal_stats.completed_count }} completed invites</p>
            </div>
            <div>
                <p class="hero-stat-label">Avg. duration</p>
                <p class="hero-stat-value">{% if portal_stats.average_duration %}{{ portal_stats.average_duration|floatformat:0 }}m{% else %}—{% endif %}</p>
                <p class="hero-stat-helper">Start to submission</p>
            </div>
            <div>
                <p class="hero-stat-label">Avg. score</p>
                <p class="hero-stat-value">{% if portal_stats.average_score %}{{ portal_stats.average_score|floatformat:1 }}{% else %}—{% endif %}</p>
                <p class="hero-stat-helper">Across finished sessions</p>
            </div>
        </div>
        <div class="portal-actions stacked">
            <a class="btn btn-outline small" href="{% url 'clients:logout' %}">Sign out</a>
            {% if can_manage_branding or is_manager %}
            <form method="post" class="summary-toggle">
                {% csrf_token %}
                <input type="hidden" name="action" value="toggle_summary">
                <label class="toggle-control">
                    <input type="checkbox" name="weekly_summary" {% if weekly_summary_enabled %}checked{% endif %} onchange="this.form.submit()">
                    <span>Weekly summary emails</span>
                </label>
            </form>
            {% endif %}
        </div>
    </header>
    <section class="portal-steps">
        <article>
            <span class="step-tag">Step 1</span>
            <h3>Pick an assessment</h3>
            <p>Use the catalog below to invite candidates to a live assignment.</p>
        </article>
        <article>
            <span class="step-tag">Step 2</span>
            <h3>Organize projects</h3>
            <p>Track active roles, invites, and hiring pods in one view.</p>
        </article>
        <article>
            <span class="step-tag">Step 3</span>
            <h3>Monitor progress</h3>
            <p>Review activity, completion stats, and plan usage at a glance.</p>
        </article>
    </section>
    {% if can_manage_branding or is_manager %}
    <div class="logo-edit-modal" data-logo-edit-modal>
        <div class="logo-edit-card">
            <button class="logo-edit-close" type="button" aria-label="Close" data-logo-edit-close>×</button>
            <p class="label">Branding</p>
            <h2>Update workspace logo</h2>
            <p class="muted">Upload a square PNG/JPG/SVG for the hero badge.</p>
            <form method="post" enctype="multipart/form-data" class="logo-form">
                {% csrf_token %}
                <input type="hidden" name="action" value="upload_logo">
                {{ logo_form.non_field_errors }}
                <div class="form-field">
                    {{ logo_form.logo.label_tag }}
                    {{ logo_form.logo }}
                    {% for error in logo_form.logo.errors %}
                    <span class="field-error">{{ error }}</span>
                    {% endfor %}
                </div>
                <button class="btn btn-pill" type="submit">Upload logo</button>
            </form>
            {% if account.has_logo %}
            <form method="post" class="remove-logo-form">
                {% csrf_token %}
                <input type="hidden" name="action" value="remove_logo">
                <button class="btn btn-ghost small" type="submit">Remove current logo</button>
            </form>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <section class="panel portal-panel assignment-highlight">
        <header>
            <div>
                <span class="step-tag subtle">Step 1</span>
                <p class="eyebrow">Assessment catalog</p>
                <h2>Invite candidates in seconds</h2>
                <p class="muted">Pick a licensed assessment below to create invites or review progress.</p>
            </div>
        </header>
        {% if allowed_assessments %}
        <div class="portal-assessment-grid">
            {% for item in allowed_assessments %}
            <article class="portal-assessment-card enhanced">
                <div class="pill subtle">Active</div>
                <h3>{{ item.label }}</h3>
                <p>{{ item.description|default:"Active license" }}</p>
                <dl class="assessment-metrics">
                    <div>
                        <dt>Invites</dt>
                        <dd>{{ item.metrics.invites|default:0 }}</dd>
                    </div>
                    <div>
                        <dt>In progress</dt>
                        <dd>{{ item.metrics.in_progress|default:0 }}</dd>
                    </div>
                    <div>
                        <dt>Completed</dt>
                        <dd>{{ item.metrics.completed|default:0 }}</dd>
                    </div>
                </dl>
                <div class="portal-assessment-actions">
                    <a class="btn btn-pill small" href="{{ item.manage_url }}">Invite candidates</a>
                </div>
            </article>
            {% endfor %}
        </div>
        {% else %}
        <p class="empty-state">No assessments approved yet. We will notify you when your licenses are ready.</p>
        {% endif %}
    </section>

    <section class="portal-card project-preview">
        <header class="project-preview-head">
            <div>
                <span class="step-tag subtle">Step 2</span>
                <p class="eyebrow">Projects</p>
                <h2>Active roles</h2>
            </div>
            <a class="btn btn-outline small" href="{% url 'clients:project-list' %}">Manage projects</a>
        </header>
        {% if project_preview %}
        <div class="project-preview-grid">
            {% for project in project_preview %}
            <article>
                <p class="label">{{ project.status }}</p>
                <h3>{{ project.title }}</h3>
                <p class="muted">{{ project.open_roles }} open · {{ project.sessions }} invites</p>
                <a class="pill subtle" href="{{ project.href }}">View</a>
            </article>
            {% endfor %}
        </div>
        {% else %}
        <p class="empty-state">No projects yet. Create one to organize invites.</p>
        {% endif %}
    </section>

    {% if notifications %}
    <section class="notification-row">
        {% for note in notifications %}
        <article class="notification-card notification-{{ note.level }}">
            <div>
                <p class="label">{{ note.title }}</p>
                <p>{{ note.message }}</p>
                {% if note.link_url %}
                <a class="link" href="{{ note.link_url }}" target="_blank" rel="noreferrer">Open link</a>
                {% endif %}
            </div>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="dismiss_notification">
                <input type="hidden" name="notification_id" value="{{ note.id }}">
                <button class="pill subtle" type="submit">Dismiss</button>
            </form>
        </article>
        {% endfor %}
    </section>
    {% endif %}

    <section class="quick-action-row">
        <header class="quick-action-head">
            <div>
                <span class="step-tag subtle">Step 3</span>
                <p class="eyebrow">Quick actions</p>
                <h2>Common follow-ups</h2>
            </div>
        </header>
        {% if quick_actions %}
        {% for action in quick_actions %}
        <a class="quick-action-card" href="{{ action.href }}" {% if action.external %}target="_blank" rel="noreferrer"{% endif %}>
            <div>
                <p class="label">{{ action.label }}</p>
                <p class="muted">{{ action.description }}</p>
            </div>
            <span aria-hidden="true">→</span>
        </a>
        {% endfor %}
        {% else %}
        <p class="empty-state">No quick actions available.</p>
        {% endif %}
    </section>

    <section class="plan-overview-panel">
        <article class="portal-card plan-card">
            <div class="plan-card-head">
                <p class="label">{{ plan_overview.name }} plan</p>
                <h2>{{ plan_overview.description }}</h2>
            </div>
            <div class="plan-usage">
                <div>
                    <div class="usage-label">
                        <p>Invites</p>
                        <span>
                            {{ plan_overview.invites_used }}
                            /
                            {% if plan_overview.invite_limit %}{{ plan_overview.invite_limit }}{% else %}Unlimited{% endif %}
                        </span>
                    </div>
                    {% if plan_overview.invite_percent %}
                    <div class="usage-bar">
                        <span style="width: {{ plan_overview.invite_percent }}%;"></span>
                    </div>
                    {% else %}
                    <p class="muted small">Unlimited invites</p>
                    {% endif %}
                </div>
                <div>
                    <div class="usage-label">
                        <p>Active projects</p>
                        <span>
                            {{ plan_overview.project_used }}
                            /
                            {% if plan_overview.project_limit %}{{ plan_overview.project_limit }}{% else %}Unlimited{% endif %}
                        </span>
                    </div>
                    {% if plan_overview.project_percent %}
                    <div class="usage-bar">
                        <span style="width: {{ plan_overview.project_percent }}%;"></span>
                    </div>
                    {% else %}
                    <p class="muted small">Unlimited projects</p>
                    {% endif %}
                </div>
            </div>
            <div class="plan-actions">
                <a class="btn btn-outline small" href="{{ plan_overview.upgrade_url }}" target="_blank">View pricing</a>
                {% if plan_overview.invite_remaining is not None and plan_overview.invite_remaining <= 5 %}
                <p class="muted tiny">Only {{ plan_overview.invite_remaining }} invites left this month.</p>
                {% elif plan_overview.project_remaining is not None and plan_overview.project_remaining <= 1 %}
                <p class="muted tiny">Only {{ plan_overview.project_remaining }} project slot{{ plan_overview.project_remaining|pluralize }} left.</p>
                {% endif %}
            </div>
        </article>
    </section>
    <main>
        <section class="portal-card-grid metric-snapshot">
            <article class="portal-card">
                <p class="label">Account status</p>
                <h2>{{ account.get_status_display }}</h2>
                <p class="muted">Point of contact: {{ account.full_name }}</p>
            </article>
            <article class="portal-card">
                <p class="label">Total invites</p>
                <h2>{{ portal_stats.total_candidates }}</h2>
                <p class="muted">All assessments combined</p>
            </article>
            <article class="portal-card">
                <p class="label">Active invites</p>
                <h2>{{ portal_stats.in_progress_count }}</h2>
                <p class="muted">Currently in progress</p>
            </article>
            <article class="portal-card">
                <p class="label">Draft invites</p>
                <h2>{{ portal_stats.draft_count }}</h2>
                <p class="muted">Awaiting launch</p>
            </article>
        </section>

        {% if benchmark %}
        <section class="portal-card-grid two-up benchmark-row">
            <article class="portal-card benchmark-card">
                <p class="label">Benchmark comparison <span class="info-badge" title="{{ benchmark_helper }}">i</span></p>
                <h2>{{ portal_stats.completion_rate|floatformat:0 }}% vs {{ benchmark.completion_rate|floatformat:0 }}%</h2>
                <p class="muted">Client completion rate vs. network average.</p>
            </article>
            <article class="portal-card benchmark-card">
                <p class="label">Avg. duration <span class="info-badge" title="{{ benchmark_helper }}">i</span></p>
                <h2>
                    {% if portal_stats.average_duration %}{{ portal_stats.average_duration|floatformat:0 }}m{% else %}—{% endif %}
                    /
                    {% if benchmark.average_duration %}{{ benchmark.average_duration|floatformat:0 }}m{% else %}—{% endif %}
                </h2>
                <p class="muted">Your candidates vs. industry peers.</p>
            </article>
        </section>
        {% endif %}

        {% if chart_payload %}
        <section class="portal-card-grid two-up charts-row">
            <article class="portal-card chart-card">
                <p class="label">Assessment mix</p>
                <h2>Invites vs. completions</h2>
                <canvas id="inviteChart"></canvas>
                <div class="mini-funnel">
                    <div>
                        <span>Invited</span>
                        <strong>{{ portal_stats.funnel.invited }}</strong>
                    </div>
                    <div>
                        <span>Started</span>
                        <strong>{{ portal_stats.funnel.started }}</strong>
                    </div>
                    <div>
                        <span>Completed</span>
                        <strong>{{ portal_stats.funnel.completed }}</strong>
                    </div>
                </div>
            </article>
            <article class="portal-card chart-card">
                <p class="label">Performance trend</p>
                <h2>Latest submissions</h2>
                <canvas id="trendChart"></canvas>
            </article>
        </section>
        {% endif %}

        <section class="activity-filter-row">
            <form method="get" class="activity-filter-form">
                <label>
                    <span>Assessment</span>
                    <select name="assessment">
                        {% for value, label in activity_filter_options.assessments %}
                        <option value="{{ value }}" {% if activity_filters.assessment == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </label>
                <label>
                    <span>Status</span>
                    <select name="status">
                        {% for value, label in activity_filter_options.statuses %}
                        <option value="{{ value }}" {% if activity_filters.status == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </label>
                <label>
                    <span>Window</span>
                    <select name="window">
                        {% for value, label in activity_filter_options.windows %}
                        <option value="{{ value }}" {% if activity_filters.window == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </label>
                <label>
                    <span>Preset</span>
                    <select name="preset">
                        {% for value, label in activity_filter_options.presets %}
                        <option value="{{ value }}" {% if activity_filters.preset == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </label>
                <button class="btn btn-outline small" type="submit">Apply</button>
                {% if activity_querystring %}
                <a class="link reset-link" href="{% url 'clients:dashboard' %}">Reset</a>
                {% endif %}
            </form>
            <a class="pill" href="{{ activity_export_url }}">Export CSV</a>
        </section>

        <section class="portal-card-grid two-up activity-row">
            <article class="portal-card attention-card">
                <p class="label">Attention</p>
                {% if attention_items %}
                <ul>
                    {% for item in attention_items %}
                    <li>
                        <strong>{{ item.label }}</strong>
                        <p>{{ item.detail }}</p>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="muted">Everything looks good. No outstanding actions.</p>
                {% endif %}
            </article>
            <article class="portal-card activity-card">
                <p class="label">Recent activity</p>
                {% if activity_feed %}
                <ul>
                    {% for entry in activity_feed %}
                    <li>
                        <div>
                            <p class="activity-name">{{ entry.candidate }}</p>
                            <span class="muted">{{ entry.assessment }} · {{ entry.status }}</span>
                        </div>
                        <div class="activity-meta">
                            <span class="muted">{{ entry.timestamp|naturaltime }}</span>
                            {% if entry.detail_url %}
                            <a class="pill subtle" href="{{ entry.detail_url }}">View report</a>
                            {% else %}
                            <a class="pill subtle" href="{{ entry.manage_url }}">Manage</a>
                            {% endif %}
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="muted">No candidate activity for this filter set.</p>
                {% endif %}
            </article>
        </section>

    </main>
</div>
{% if chart_payload %}
{{ chart_payload|json_script:"client-chart-data" }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
(function() {
    const payload = JSON.parse(document.getElementById("client-chart-data").textContent);
    const breakdown = payload.breakdown || [];
    const trend = payload.trend || [];
    const inviteCtx = document.getElementById("inviteChart");
    const trendCtx = document.getElementById("trendChart");
    if (inviteCtx && breakdown.length) {
        new Chart(inviteCtx, {
            type: "bar",
            data: {
                labels: breakdown.map((b) => b.label),
                datasets: [
                    {
                        label: "Invites",
                        data: breakdown.map((b) => b.invites),
                        backgroundColor: "rgba(255,138,0,0.35)",
                        borderRadius: 12,
                    },
                    {
                        label: "Completed",
                        data: breakdown.map((b) => b.completed),
                        backgroundColor: "rgba(14,20,40,0.8)",
                        borderRadius: 12,
                    },
                ],
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: "bottom" },
                },
                scales: {
                    y: { beginAtZero: true },
                },
            },
        });
    }
    if (trendCtx && trend.length) {
        new Chart(trendCtx, {
            type: "line",
            data: {
                labels: trend.map((t) => t.label),
                datasets: [
                    {
                        label: "Score",
                        data: trend.map((t) => t.score),
                        borderColor: "rgba(14,20,40,0.9)",
                        backgroundColor: "rgba(14,20,40,0.1)",
                        tension: 0.35,
                        fill: true,
                    },
                ],
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                },
                scales: {
                    y: { beginAtZero: true, suggestedMax: 100 },
                },
            },
        });
    }
})();
</script>
{% endif %}
{% endblock %}
            <article class="portal-card">
                <p class="label">Hiring objectives</p>
                <h2>Focus</h2>
                <p class="muted">{% if account_objectives %}{{ account_objectives|linebreaksbr }}{% else %}No objectives provided yet.{% endif %}</p>
            </article>
{% block site_footer %}{% endblock %}
