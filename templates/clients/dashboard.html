{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="portal-shell">
    <header class="portal-hero">
        <div class="portal-hero-icon">
            <span>⚡</span>
        </div>
        <div>
            <p class="eyebrow">Welcome back</p>
            <h1>{{ account.company_name }}</h1>
            <p class="muted">You have access to {{ allowed_assessments|length }} assessment{{ allowed_assessments|pluralize }}.</p>
        </div>
        <div class="portal-actions">
            <a class="btn btn-outline small" href="{% url 'clients:logout' %}">Sign out</a>
        </div>
    </header>

    <main>
        <section class="portal-card-grid three-up">
            <article class="portal-card">
                <p class="label">Status</p>
                <h2>{{ account.get_status_display }}</h2>
                <p class="muted">Approved assessments unlock candidate invites.</p>
            </article>
            <article class="portal-card">
                <p class="label">Employee size</p>
                <h2>{{ account.get_employee_size_display }}</h2>
                <p class="muted">Point of contact: {{ account.full_name }}</p>
            </article>
            <article class="portal-card">
                <p class="label">Total candidates</p>
                <h2>{{ portal_stats.total_candidates }}</h2>
                <p class="muted"> invites across all assessments</p>
            </article>
            <article class="portal-card">
                <p class="label">Average score</p>
                <h2>{% if portal_stats.average_score %}{{ portal_stats.average_score|floatformat:1 }}{% else %}—{% endif %}</h2>
                <p class="muted">Across completed sessions</p>
            </article>
            <article class="portal-card">
                <p class="label">Average duration</p>
                <h2>{% if portal_stats.average_duration %}{{ portal_stats.average_duration|floatformat:0 }} min{% else %}—{% endif %}</h2>
                <p class="muted">From start to submission</p>
            </article>
            <article class="portal-card card-muted">
                <p class="label">Support</p>
                <h2>Account manager</h2>
                <p class="muted">Update priorities via your account manager.</p>
            </article>
        </section>

        {% if chart_payload %}
        <section class="portal-card-grid two-up charts-row">
            <article class="portal-card chart-card">
                <p class="label">Invite mix</p>
                <h2>Invites vs. completions</h2>
                <canvas id="inviteChart"></canvas>
            </article>
            <article class="portal-card chart-card">
                <p class="label">Recent scores</p>
                <h2>Latest submissions</h2>
                <canvas id="trendChart"></canvas>
            </article>
        </section>
        {% endif %}

        <section class="panel portal-panel">
            <header>
                <div>
                    <p class="eyebrow">Assessment catalog</p>
                    <h2>Live licenses</h2>
                </div>
            </header>
            {% if allowed_assessments %}
            <div class="portal-assessment-grid">
                {% for item in allowed_assessments %}
                <article class="portal-assessment-card">
                    <div class="pill subtle">Active</div>
                    <h3>{{ item.label }}</h3>
                    <p>{{ item.description|default:"Active license" }}</p>
                    <div class="portal-assessment-actions">
                        <a class="btn btn-outline small" href="{{ item.manage_url }}">Manage invites</a>
                    </div>
                </article>
                {% endfor %}
            </div>
            {% else %}
            <p class="empty-state">No assessments approved yet. We will notify you when your licenses are ready.</p>
            {% endif %}
        </section>
    </main>
</div>
{% if chart_payload %}
{{ chart_payload|json_script:"client-chart-data" }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
(function() {
    const payload = JSON.parse(document.getElementById("client-chart-data").textContent);
    const breakdown = payload.breakdown || [];
    const trend = payload.trend || [];
    const inviteCtx = document.getElementById("inviteChart");
    const trendCtx = document.getElementById("trendChart");
    if (inviteCtx && breakdown.length) {
        new Chart(inviteCtx, {
            type: "bar",
            data: {
                labels: breakdown.map((b) => b.label),
                datasets: [
                    {
                        label: "Invites",
                        data: breakdown.map((b) => b.invites),
                        backgroundColor: "rgba(255,138,0,0.35)",
                        borderRadius: 12,
                    },
                    {
                        label: "Completed",
                        data: breakdown.map((b) => b.completed),
                        backgroundColor: "rgba(14,20,40,0.8)",
                        borderRadius: 12,
                    },
                ],
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: "bottom" },
                },
                scales: {
                    y: { beginAtZero: true },
                },
            },
        });
    }
    if (trendCtx && trend.length) {
        new Chart(trendCtx, {
            type: "line",
            data: {
                labels: trend.map((t) => t.label),
                datasets: [
                    {
                        label: "Score",
                        data: trend.map((t) => t.score),
                        borderColor: "rgba(14,20,40,0.9)",
                        backgroundColor: "rgba(14,20,40,0.1)",
                        tension: 0.35,
                        fill: true,
                    },
                ],
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                },
                scales: {
                    y: { beginAtZero: true, suggestedMax: 100 },
                },
            },
        });
    }
})();
</script>
{% endif %}
{% endblock %}
