{% extends 'base.html' %}
{% load humanize %}
{% block content %}
<div class="portal-shell">
    <section class="portal-hero compact">
        <div>
            <p class="eyebrow">{{ assessment_label }}</p>
            <h1>{{ session_obj.candidate_id }}</h1>
            <p class="muted">Status: {{ session_obj.get_status_display }}</p>
        </div>
        <div class="portal-actions">
            <a class="btn btn-outline small" href="{% url 'clients:assessment-manage' assessment_type %}">Back to sessions</a>
        </div>
    </section>

    {% if actionable_summary %}
    <section class="panel portal-panel summary-callout tone-{{ actionable_summary.tone }}">
        <div class="summary-callout-responsive">
            <div class="summary-callout-main">
                <span class="pill">{{ actionable_summary.label }}</span>
                <h2>{{ actionable_summary.headline }}</h2>
                <p>{{ actionable_summary.subline }}</p>
            </div>
            <div class="summary-callout-metrics">
                <article class="metric-chip">
                    <p class="label">Score</p>
                    <strong>{{ actionable_summary.metrics.score }}</strong>
                </article>
                <article class="metric-chip">
                    <p class="label">Risk</p>
                    <strong>{{ actionable_summary.metrics.flags }}</strong>
                </article>
                <article class="metric-chip">
                    <p class="label">Highlight</p>
                    <strong>{{ actionable_summary.metrics.strength }}</strong>
                </article>
            </div>
        </div>
    </section>
    {% endif %}

    {% if can_record_decision %}
    <section class="panel portal-panel decision-cta-panel">
        <header>
            <div>
                <p class="eyebrow">Next steps</p>
                <h2>Take action</h2>
            </div>
        </header>
        <form method="post" class="decision-cta-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="quick_decision">
            <div class="decision-tabs">
                <button type="submit" name="decision" value="advance" class="decision-tab positive">
                    <span class="tab-title">Advance</span>
                    <span class="tab-helper">Move to next stage</span>
                </button>
                <button type="submit" name="decision" value="hold" class="decision-tab neutral">
                    <span class="tab-title">Hold</span>
                    <span class="tab-helper">Need more signals</span>
                </button>
                <button type="submit" name="decision" value="reject" class="decision-tab warning">
                    <span class="tab-title">Reject</span>
                    <span class="tab-helper">Send decline note</span>
                </button>
            </div>
            <label class="decision-note">
                <span>Add context (optional)</span>
                <textarea name="note" rows="2" placeholder="Add next steps or notes for the candidate"></textarea>
            </label>
        </form>
        {% if quick_followups %}
        <div class="followup-grid">
            {% for link in quick_followups %}
            <article class="followup-card">
                <div>
                    <p class="card-title">{{ link.label }}</p>
                    <p class="muted">{{ link.description }}</p>
                </div>
                <a class="pill subtle" href="{{ link.href }}" {% if link.external %}target="_blank" rel="noreferrer"{% endif %}>
                    Open
                </a>
            </article>
            {% endfor %}
        </div>
        {% endif %}
    </section>
    {% endif %}

    {% if response_drilldown %}
    <section class="panel portal-panel drilldown-panel exportable" id="report-body">
        <header>
            <div>
                <p class="eyebrow">Scenario drill-down</p>
                <h2>Responses & timing</h2>
            </div>
        </header>
        <div class="drilldown-list">
            {% for item in response_drilldown %}
            <details>
                <summary>
                    <div>
                        <strong>{{ item.prompt }}</strong>
                        {% if item.category %}<span class="muted">{{ item.category|title }}</span>{% endif %}
                    </div>
                    <span class="drilldown-status {{ item.outcome_class }}">{{ item.outcome }}</span>
                </summary>
                <div class="drilldown-body">
                    <p><strong>Candidate response:</strong> {{ item.answer }}</p>
                    <p><strong>Time spent:</strong> {{ item.elapsed }}</p>
                </div>
            </details>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    {% if activity_timeline %}
    <section class="panel portal-panel timeline-panel">
        <header>
            <div>
                <p class="eyebrow">Candidate journey</p>
                <h2>Timeline</h2>
            </div>
        </header>
        <ol class="timeline-list">
            {% for event in activity_timeline %}
            <li>
                <div class="timeline-dot"></div>
                <div>
                    <div class="timeline-header">
                        <p class="timeline-label">{{ event.label }}</p>
                        <span class="timeline-meta">{{ event.timestamp|naturaltime }}</span>
                    </div>
                    <p class="timeline-desc">
                        <span>{{ event.timestamp|date:"M j, Y · H:i" }}</span>
                        <span>{{ event.description }}</span>
                    </p>
                </div>
            </li>
            {% endfor %}
        </ol>
    </section>
    {% endif %}

    {% if comparative_insights.cohort_total %}
    <section class="panel portal-panel comparative-panel">
        <header>
            <div>
                <p class="eyebrow">Comparative insights</p>
                <h2>Pipeline context</h2>
            </div>
        </header>
        <div class="comparative-grid">
            <article class="metric-chip">
                <p class="label">Percentile</p>
                <strong>{% if comparative_insights.percentile %}Top {{ comparative_insights.percentile|floatformat:0 }}%{% else %}—{% endif %}</strong>
            </article>
            <article class="metric-chip">
                <p class="label">Cohort size</p>
                <strong>{{ comparative_insights.cohort_total }}</strong>
                <p class="muted">{{ comparative_insights.cohort_recent }} in last 30 days</p>
            </article>
            <article class="metric-chip">
                <p class="label">Avg. score</p>
                <strong>{% if comparative_insights.cohort_avg %}{{ comparative_insights.cohort_avg|floatformat:1 }}{% else %}—{% endif %}</strong>
            </article>
            <article class="metric-chip">
                <p class="label">Top score</p>
                <strong>{% if comparative_insights.top_score %}{{ comparative_insights.top_score|floatformat:1 }}{% else %}—{% endif %}</strong>
            </article>
        </div>
    </section>
    {% endif %}

    {% if candidate_feedback %}
    <section class="panel portal-panel feedback-insight">
        <header>
            <div>
                <p class="eyebrow">Candidate experience</p>
                <h2>Post-assessment feedback</h2>
            </div>
        </header>
        <div class="feedback-insight-grid">
            <article>
                <p class="label">Rating</p>
                <strong>{% if candidate_feedback.label %}{{ candidate_feedback.label }}{% elif candidate_feedback.score %}{{ candidate_feedback.score }} / 5{% else %}—{% endif %}</strong>
            </article>
            <article>
                <p class="label">Submitted</p>
                <strong>{% if candidate_feedback.submitted_at %}{{ candidate_feedback.submitted_at|naturaltime }}{% else %}—{% endif %}</strong>
            </article>
        </div>
        {% if candidate_feedback.comment %}
        <p class="muted">“{{ candidate_feedback.comment }}”</p>
        {% endif %}
        {% if candidate_feedback.contact_email or candidate_feedback.contact_phone %}
        <div class="feedback-contact">
            {% if candidate_feedback.contact_email %}
            <p><strong>Email:</strong> <a href="mailto:{{ candidate_feedback.contact_email }}">{{ candidate_feedback.contact_email }}</a></p>
            {% endif %}
            {% if candidate_feedback.contact_phone %}
            <p><strong>Phone / chat:</strong> {{ candidate_feedback.contact_phone }}</p>
            {% endif %}
            {% if candidate_feedback.allow_follow_up %}
            <p class="pill subtle success">Candidate opted in for follow-up</p>
            {% endif %}
        </div>
        {% endif %}
    </section>
    {% endif %}

    {% if integrity_signals %}
    <section class="panel portal-panel integrity-panel">
        <header>
            <div>
                <p class="eyebrow">Integrity signals</p>
                <h2>Environment telemetry</h2>
            </div>
        </header>
        <div class="integrity-grid">
            <article>
                <p class="label">Primary IP</p>
                <strong>{{ integrity_signals.ip_address|default:"—" }}</strong>
                {% if integrity_signals.ip_switches %}
                <p class="muted">{{ integrity_signals.ip_switches }} change(s) detected</p>
                {% endif %}
            </article>
            <article>
                <p class="label">Device</p>
                <p class="muted">{{ integrity_signals.user_agent|default:"Unknown" }}</p>
                {% if integrity_signals.timezone %}
                <p class="muted">Timezone: {{ integrity_signals.timezone }}</p>
                {% endif %}
            </article>
            <article>
                <p class="label">Paste events</p>
                <strong>{{ integrity_signals.paste_count }}</strong>
            </article>
        </div>
        {% if integrity_signals.last_event %}
        <p class="muted small">Last telemetry event captured {{ integrity_signals.last_event.timestamp }}</p>
        {% endif %}
    </section>
    {% endif %}

    {% if audit_log %}
    <section class="panel portal-panel audit-panel">
        <header>
            <div>
                <p class="eyebrow">Audit trail</p>
                <h2>Recent activity</h2>
            </div>
        </header>
        <div class="audit-grid">
            {% for item in audit_log %}
            <article class="audit-card">
                <span class="audit-time">{{ item.timestamp|naturaltime }}</span>
                <h3>{{ item.label }}</h3>
                <p>{{ item.description }}</p>
            </article>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <section class="panel portal-panel">
        <header>
            <div>
                <p class="eyebrow">Summary</p>
                <h2>Candidate performance</h2>
            </div>
        </header>
        <div class="summary-grid">
            <article class="summary-card">
                <h3>Overall score</h3>
                <p class="summary-value">{% if report.score %}{{ report.score|floatformat:2 }}{% elif report.overall %}{{ report.overall|floatformat:2 }}{% else %}—{% endif %}</p>
                <a class="link" href="{{ share_link }}" target="_blank">Share report</a>
            </article>
            {% if assessment_type == 'behavioral' and report.label %}
            <article class="summary-card">
                <h3>Eligibility decision</h3>
                <p class="summary-value">{{ report.label }}</p>
                <p class="muted">Behavioral eligibility rating</p>
            </article>
            {% elif assessment_type != 'behavioral' %}
            <article class="summary-card">
                <h3>Skill mix</h3>
                <p class="summary-value">{{ report.hard|default:'—' }}/{{ report.soft|default:'—' }}</p>
                <p class="muted">Hard vs. soft skills</p>
            </article>
            {% endif %}
            {% if report.seniority %}
            <article class="summary-card">
                <h3>Recommended level</h3>
                <p class="summary-value">{{ report.seniority }}</p>
                <p class="muted">Suggested seniority band</p>
            </article>
            {% endif %}
        </div>
    </section>

    {% if decision_summary %}
    <section class="panel portal-panel review-panel">
        <header>
            <div>
                <p class="eyebrow">Review panel</p>
                <h2>Decision votes</h2>
            </div>
        </header>
        <div class="review-grid">
            {% for item in decision_summary %}
            <article class="review-card{% if recommended_decision and recommended_decision.decision == item.decision %} is-recommended{% endif %}">
                <span class="badge">{{ item.decision|title }}</span>
                <strong>{{ item.count }}</strong>
            </article>
            {% endfor %}
        </div>
        {% if recommended_decision %}
        <p class="muted">Recommended direction: <strong>{{ recommended_decision.decision|title }}</strong></p>
        {% endif %}
    </section>
    {% endif %}

    <section class="panel portal-panel">
        {% if assessment_type == 'behavioral' %}
        <header>
            <div>
                <p class="eyebrow">Behavioral breakdown</p>
                <h2>Trait scores</h2>
            </div>
        </header>
        <div class="heatmap-grid">
            {% for trait, score in report.traits.items %}
            {% with percent=score|floatformat:0 %}
            <article class="trait-bar">
                <div class="trait-bar-header">
                    <span class="label">{{ trait|title }}</span>
                    <span class="value">{% if score %}{{ score|floatformat:1 }}{% else %}—{% endif %}</span>
                </div>
                <div class="progress">
                    <div class="progress-fill" style="width: {{ percent }}%;"></div>
                </div>
            </article>
            {% endwith %}
            {% endfor %}
        </div>
        <header>
            <div>
                <h2>Risk flags</h2>
            </div>
        </header>
        {% if report.flags %}
        <div class="risk-grid">
            {% for flag in report.flags %}
            {% with severity=flag.level|default:"watchlist"|lower %}
            <article class="risk-card severity-{{ severity }}">
                <div class="risk-icon" aria-hidden="true">!</div>
                <div class="risk-copy">
                    <h3>{{ flag.trait|default:flag.code|title }}</h3>
                    <p>{{ flag.reason }}</p>
                </div>
                <span class="risk-pill">{{ severity|title }}</span>
            </article>
            {% endwith %}
            {% endfor %}
        </div>
        {% else %}
        <p class="empty-state">No red flags triggered.</p>
        {% endif %}
        {% else %}
        <header>
            <div>
                <p class="eyebrow">Category breakdown</p>
                <h2>Skill profile</h2>
            </div>
        </header>
        <div class="heatmap-grid">
            {% for item in report.category_heatmap %}
            <article class="heatmap-card status-{{ item.status }}">
                <p class="label">{{ item.label|title }}</p>
                <strong>{% if item.score is not None %}{{ item.score|floatformat:0 }}{% else %}—{% endif %}</strong>
            </article>
            {% endfor %}
        </div>
        <div class="table">
            <div class="table-row table-head">
                <span>Category</span>
                <span>Score</span>
            </div>
            {% for cat, value in report.categories.items %}
            <div class="table-row">
                <span>{{ cat|title }}</span>
                <span>{{ value }}</span>
            </div>
            {% endfor %}
        </div>
        <header>
            <div>
                <h2>Fit signals</h2>
            </div>
        </header>
        {% if report.fit_scores %}
        <div class="table">
            <div class="table-row table-head">
                <span>Domain</span>
                <span>Score</span>
            </div>
            {% for domain, score in report.fit_scores.items %}
            <div class="table-row">
                <span>{{ domain|title }}</span>
                <span>{{ score }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        <div class="chip-row">
            {% if report.strengths %}
            <div>
                <p class="label">Strengths</p>
                {% for item in report.strengths %}
                <span class="chip">{{ item|title }}</span>
                {% endfor %}
            </div>
            {% endif %}
            {% if report.development %}
                <div>
                    <p class="label">Development areas</p>
                    {% for item in report.development %}
                    <span class="chip warning">{{ item|title }}</span>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        {% if not report.fit_scores and not report.strengths and not report.development %}
        <p class="muted">No recommendation data recorded.</p>
        {% endif %}
        {% endif %}
    </section>

    <section class="panel portal-panel notes-panel">
        <header>
            <div>
                <p class="eyebrow">Collaboration</p>
                <h2>Candidate notes</h2>
            </div>
        </header>
        {% if can_edit_notes or can_record_decision %}
        <form method="post" class="note-form">
            {% csrf_token %}
            {{ note_form.non_field_errors }}
            <div class="form-field">
                {{ note_form.note_type.label_tag }}
                {{ note_form.note_type }}
                {% for error in note_form.note_type.errors %}
                <span class="field-error">{{ error }}</span>
                {% endfor %}
            </div>
            <div class="form-field">
                {{ note_form.decision.label_tag }}
                {{ note_form.decision }}
                {% for error in note_form.decision.errors %}
                <span class="field-error">{{ error }}</span>
                {% endfor %}
            </div>
            <div class="form-field">
                {{ note_form.note.label_tag }}
                {{ note_form.note }}
                {% for error in note_form.note.errors %}
                <span class="field-error">{{ error }}</span>
                {% endfor %}
            </div>
            <label class="note-flag">
                {{ note_form.needs_review }}
                <span>{{ note_form.needs_review.label }}</span>
            </label>
            {% for error in note_form.needs_review.errors %}
            <span class="field-error">{{ error }}</span>
            {% endfor %}
            <button class="btn btn-outline small" type="submit">Save note</button>
        </form>
        {% else %}
        <p class="muted">You have viewer access. Contact your admin to share feedback.</p>
        {% endif %}
        <div class="notes-timeline">
            {% if notes %}
            <ul class="notes-list">
                {% for note in notes %}
                <li>
                    <div class="note-dot"></div>
                    <div class="note-body">
                        <div class="note-heading">
                            <p class="note-meta">
                                {{ note.created_at|naturaltime }}
                                {% if note.author %}· {{ note.author.get_full_name|default:note.author.username }}{% endif %}
                            </p>
                            {% if note.note_type == 'decision' %}
                            <span class="badge">{{ note.get_decision_display }}</span>
                            {% endif %}
                        </div>
                        {% if note.note %}
                        <p>{{ note.note }}</p>
                        {% endif %}
                        <p class="muted">
                            {{ note.get_note_type_display }} · {{ note.get_author_role_display|default:note.author_role|title }}
                        </p>
                        {% if note.needs_review %}
                        <span class="pill warning">Needs review</span>
                        {% endif %}
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="muted">No notes yet. Use the form above to capture feedback or flag follow-ups.</p>
            {% endif %}
        </div>
    </section>
</div>
{% endblock %}
        {% if pdf_export_url %}
        <a class="pill" href="{{ pdf_export_url }}" target="_blank" rel="noreferrer">Download PDF</a>
        {% endif %}
