{% extends 'portal_base.html' %}
{% load static %}
{% load humanize %}
{% block title %}{{ session_obj.candidate_id }} · {{ assessment_label }} · Evalon{% endblock %}
{% block meta_description %}Assessment report for {{ session_obj.candidate_id }}.{% endblock %}
{% block portal_content %}
<div class="portal-shell">
    {# Report Header #}
    <header class="page-header-with-actions">
        <div>
            <div class="breadcrumb-nav">
                <a href="{% url 'clients:assessments' %}" class="breadcrumb-link">Assessments</a>
                <span class="breadcrumb-separator">›</span>
                <a href="{% url 'clients:assessment-manage' assessment_type %}" class="breadcrumb-link">{{ assessment_label }}</a>
                <span class="breadcrumb-separator">›</span>
                <span class="breadcrumb-current">{{ session_obj.candidate_id }}</span>
            </div>
            <h1>{{ session_obj.candidate_id }}</h1>
            <div class="report-meta">
                <span class="status-badge status-{{ session_obj.status }}">{{ session_obj.get_status_display }}</span>
                {% if session_obj.submitted_at %}
                <span class="meta-text">Submitted {{ session_obj.submitted_at|naturaltime }}</span>
                {% endif %}
            </div>
        </div>
        <div class="header-actions">
            {% if share_link %}
            <a href="{{ share_link }}" target="_blank" class="btn btn-ghost">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                    <polyline points="16 6 12 2 8 6"></polyline>
                    <line x1="12" y1="2" x2="12" y2="15"></line>
                </svg>
                Share Report
            </a>
            {% endif %}
        </div>
    </header>

    {# Recommendation Banner - Only if actionable summary exists #}
    {% if actionable_summary %}
    <section class="portal-card recommendation-banner tone-{{ actionable_summary.tone }}">
        <div class="recommendation-content">
            <div class="recommendation-header">
                <span class="recommendation-badge">{{ actionable_summary.label }}</span>
                <h2>{{ actionable_summary.headline }}</h2>
                <p>{{ actionable_summary.subline }}</p>
            </div>
            <div class="recommendation-metrics">
                <div class="metric-chip">
                    <span class="chip-label">Score</span>
                    <span class="chip-value">{{ actionable_summary.metrics.score }}</span>
                </div>
                <div class="metric-chip">
                    <span class="chip-label">Risk</span>
                    <span class="chip-value">{{ actionable_summary.metrics.flags }}</span>
                </div>
                <div class="metric-chip">
                    <span class="chip-label">Highlight</span>
                    <span class="chip-value">{{ actionable_summary.metrics.strength }}</span>
                </div>
            </div>
        </div>
    </section>
    {% endif %}

    {# Key Performance Metrics - 3 cards #}
    <section class="portal-card-grid three-up key-metrics">
        <article class="portal-card metric-card">
            <p class="label">Overall score</p>
            <h2 class="metric-value">
                {% if report.score %}{{ report.score|floatformat:1 }}{% elif report.overall %}{{ report.overall|floatformat:1 }}{% else %}—{% endif %}
            </h2>
            <p class="muted">
                {% if comparative_insights.cohort_total %}
                    vs. avg {{ comparative_insights.cohort_avg|floatformat:1 }}
                {% else %}
                    Final assessment score
                {% endif %}
            </p>
        </article>
        <article class="portal-card metric-card">
            <p class="label">Recommendation</p>
            <h2 class="metric-value metric-text">
                {% if report.seniority %}
                    {{ report.seniority }}
                {% elif report.label %}
                    {{ report.label }}
                {% else %}
                    —
                {% endif %}
            </h2>
            <p class="muted">Suggested seniority level</p>
        </article>
        <article class="portal-card metric-card">
            <p class="label">Ranking</p>
            <h2 class="metric-value metric-text">
                {% if comparative_insights.percentile %}
                    Top {{ comparative_insights.percentile|floatformat:0 }}%
                {% else %}
                    —
                {% endif %}
            </h2>
            <p class="muted">
                {% if comparative_insights.cohort_total %}
                    Among {{ comparative_insights.cohort_total }} candidates
                {% else %}
                    No comparison data
                {% endif %}
            </p>
        </article>
    </section>

    {# Take Action Section - Only if can record decision #}
    {% if can_record_decision %}
    <section class="take-action-section">
        <div class="section-header">
            <h3>Take Action</h3>
            <p class="muted">Record your hiring decision</p>
        </div>
        <div class="portal-card">
            <form method="post" class="action-form">
                {% csrf_token %}
                <input type="hidden" name="action" value="quick_decision">
                <div class="action-buttons">
                    <button type="submit" name="decision" value="advance" class="action-button action-advance">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                        <div>
                            <span class="action-label">Advance</span>
                            <span class="action-hint">Move to next stage</span>
                        </div>
                    </button>
                    <button type="submit" name="decision" value="hold" class="action-button action-hold">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <div>
                            <span class="action-label">Hold</span>
                            <span class="action-hint">Need more signals</span>
                        </div>
                    </button>
                    <button type="submit" name="decision" value="reject" class="action-button action-reject">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                        <div>
                            <span class="action-label">Reject</span>
                            <span class="action-hint">Send decline note</span>
                        </div>
                    </button>
                </div>
                <div class="action-note">
                    <label for="decision-note">Add context (optional)</label>
                    <textarea id="decision-note" name="note" rows="2" placeholder="Add next steps or notes for the candidate"></textarea>
                </div>
            </form>
        </div>
    </section>
    {% endif %}

    {# Candidate Journey Timeline #}
    {% if activity_timeline %}
    <section class="timeline-section">
        <div class="section-header">
            <h3>Candidate Journey</h3>
            <p class="muted">Key milestones and events</p>
        </div>
        <div class="portal-card">
            <div class="journey-timeline">
                {% for event in activity_timeline %}
                <div class="timeline-event">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <div class="timeline-header">
                            <strong>{{ event.label }}</strong>
                            <span class="timeline-time">{{ event.timestamp|naturaltime }}</span>
                        </div>
                        <p class="timeline-description muted">{{ event.description }}</p>
                        <span class="timeline-date">{{ event.timestamp|date:"M j, Y · H:i" }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>
    {% endif %}

    {# Performance Breakdown #}
    <section class="performance-section">
        <div class="section-header">
            <h3>{% if assessment_type == 'behavioral' %}Behavioral Profile{% else %}Skill Breakdown{% endif %}</h3>
            <p class="muted">Detailed performance analysis</p>
        </div>

        {% if assessment_type == 'behavioral' %}
        {# Behavioral Assessment - Trait Scores #}
        {% if report.traits %}
        <div class="portal-card-grid two-up">
            {% for trait, score in report.traits.items %}
            <article class="portal-card trait-card">
                <div class="trait-header">
                    <h4>{{ trait|title }}</h4>
                    <span class="trait-score">{% if score %}{{ score|floatformat:1 }}{% else %}—{% endif %}</span>
                </div>
                <div class="trait-bar">
                    <div class="trait-fill" style="width: {{ score|floatformat:0 }}%;"></div>
                </div>
            </article>
            {% endfor %}
        </div>
        {% endif %}

        {# Risk Flags #}
        {% if report.flags %}
        <div class="section-header">
            <h3>Risk Flags</h3>
            <p class="muted">Areas requiring attention</p>
        </div>
        <div class="portal-card-grid two-up">
            {% for flag in report.flags %}
            <article class="portal-card risk-card severity-{{ flag.level|default:'watchlist'|lower }}">
                <div class="risk-icon">⚠</div>
                <div class="risk-content">
                    <h4>{{ flag.trait|default:flag.code|title }}</h4>
                    <p>{{ flag.reason }}</p>
                    <span class="risk-level">{{ flag.level|default:'Watchlist'|title }}</span>
                </div>
            </article>
            {% endfor %}
        </div>
        {% endif %}

        {% else %}
        {# Skills Assessment - Category Heatmap #}
        {% if report.category_heatmap %}
        <div class="portal-card-grid skill-grid">
            {% for item in report.category_heatmap %}
            <article class="portal-card skill-card status-{{ item.status }}">
                <h4>{{ item.label|title }}</h4>
                <div class="skill-score">
                    {% if item.score is not None %}{{ item.score|floatformat:0 }}{% else %}—{% endif %}
                </div>
            </article>
            {% endfor %}
        </div>
        {% endif %}

        {# Detailed Category Scores #}
        {% if report.categories %}
        <div class="portal-card">
            <div class="category-table">
                <div class="category-header">
                    <span>Category</span>
                    <span>Score</span>
                </div>
                {% for cat, value in report.categories.items %}
                <div class="category-row">
                    <span class="category-name">{{ cat|title }}</span>
                    <span class="category-score">{{ value|floatformat:1 }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {# Strengths and Development Areas #}
        {% if report.strengths or report.development %}
        <div class="portal-card strengths-card">
            {% if report.strengths %}
            <div class="strengths-section">
                <h4>Strengths</h4>
                <div class="chip-list">
                    {% for item in report.strengths %}
                    <span class="chip chip-success">{{ item|title }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% if report.development %}
            <div class="development-section">
                <h4>Development Areas</h4>
                <div class="chip-list">
                    {% for item in report.development %}
                    <span class="chip chip-warning">{{ item|title }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
        {% endif %}
    </section>

    {# Candidate Notes #}
    <section class="notes-section">
        <div class="section-header">
            <h3>Team Notes</h3>
            <p class="muted">Shared feedback and decisions</p>
        </div>
        <div class="portal-card">
            {% if can_edit_notes or can_record_decision %}
            <form method="post" class="notes-form">
                {% csrf_token %}
                {{ note_form.non_field_errors }}
                <div class="notes-form-grid">
                    <div class="form-field">
                        {{ note_form.note_type.label_tag }}
                        {{ note_form.note_type }}
                        {% for error in note_form.note_type.errors %}
                        <span class="field-error">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="form-field">
                        {{ note_form.decision.label_tag }}
                        {{ note_form.decision }}
                        {% for error in note_form.decision.errors %}
                        <span class="field-error">{{ error }}</span>
                        {% endfor %}
                    </div>
                </div>
                <div class="form-field">
                    {{ note_form.note.label_tag }}
                    {{ note_form.note }}
                    {% for error in note_form.note.errors %}
                    <span class="field-error">{{ error }}</span>
                    {% endfor %}
                </div>
                <div class="form-actions">
                    <label class="checkbox-label">
                        {{ note_form.needs_review }}
                        <span>{{ note_form.needs_review.label }}</span>
                    </label>
                    <button type="submit" class="btn btn-primary">Save Note</button>
                </div>
            </form>
            {% endif %}

            {# Notes List #}
            {% if notes %}
            <div class="notes-list">
                {% for note in notes %}
                <div class="note-item">
                    <div class="note-header">
                        <div class="note-meta">
                            <span class="note-author">
                                {% if note.author %}{{ note.author.get_full_name|default:note.author.username }}{% else %}System{% endif %}
                            </span>
                            <span class="note-time">{{ note.created_at|naturaltime }}</span>
                        </div>
                        {% if note.note_type == 'decision' %}
                        <span class="note-badge">{{ note.get_decision_display }}</span>
                        {% endif %}
                    </div>
                    {% if note.note %}
                    <p class="note-content">{{ note.note }}</p>
                    {% endif %}
                    <div class="note-footer">
                        <span class="note-type">{{ note.get_note_type_display }}</span>
                        {% if note.needs_review %}
                        <span class="badge badge-warning">Needs Review</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="empty-note-state">No notes yet. Use the form above to add feedback or flag follow-ups.</p>
            {% endif %}
        </div>
    </section>

    {# Advanced Details (Collapsed by default) #}
    <details class="advanced-section">
        <summary class="advanced-toggle">
            <h3>Advanced Details</h3>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
        </summary>

        <div class="advanced-content">
            {# Candidate Feedback #}
            {% if candidate_feedback %}
            <div class="portal-card feedback-card">
                <h4>Candidate Feedback</h4>
                <div class="feedback-grid">
                    <div>
                        <span class="label">Rating</span>
                        <strong>{% if candidate_feedback.label %}{{ candidate_feedback.label }}{% elif candidate_feedback.score %}{{ candidate_feedback.score }}/5{% else %}—{% endif %}</strong>
                    </div>
                    <div>
                        <span class="label">Submitted</span>
                        <strong>{% if candidate_feedback.submitted_at %}{{ candidate_feedback.submitted_at|naturaltime }}{% else %}—{% endif %}</strong>
                    </div>
                </div>
                {% if candidate_feedback.comment %}
                <p class="feedback-comment">"{{ candidate_feedback.comment }}"</p>
                {% endif %}
            </div>
            {% endif %}

            {# Integrity Signals #}
            {% if integrity_signals %}
            <div class="portal-card integrity-card">
                <h4>Environment Telemetry</h4>
                <div class="integrity-grid">
                    <div>
                        <span class="label">Primary IP</span>
                        <span>{{ integrity_signals.ip_address|default:"—" }}</span>
                        {% if integrity_signals.ip_switches %}
                        <span class="muted">{{ integrity_signals.ip_switches }} change(s)</span>
                        {% endif %}
                    </div>
                    <div>
                        <span class="label">Device</span>
                        <span class="muted">{{ integrity_signals.user_agent|default:"Unknown" }}</span>
                    </div>
                    <div>
                        <span class="label">Paste Events</span>
                        <span>{{ integrity_signals.paste_count }}</span>
                    </div>
                </div>
            </div>
            {% endif %}

            {# Responses Drilldown #}
            {% if response_drilldown %}
            <div class="portal-card responses-card">
                <h4>Response Details</h4>
                {% for item in response_drilldown|slice:":5" %}
                <details class="response-item">
                    <summary>
                        <strong>{{ item.prompt }}</strong>
                        <span class="response-outcome {{ item.outcome_class }}">{{ item.outcome }}</span>
                    </summary>
                    <div class="response-details">
                        <p><strong>Answer:</strong> {{ item.answer }}</p>
                        <p><strong>Time:</strong> {{ item.elapsed }}</p>
                    </div>
                </details>
                {% endfor %}
                {% if response_drilldown|length > 5 %}
                <p class="muted">Showing 5 of {{ response_drilldown|length }} responses</p>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </details>
</div>


{% endblock %}
