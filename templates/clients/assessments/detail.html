{% extends 'base.html' %}
{% load humanize %}
{% block content %}
<div class="portal-shell">
    <section class="portal-hero compact">
        <div>
            <p class="eyebrow">{{ assessment_label }}</p>
            <h1>{{ session_obj.candidate_id }}</h1>
            <p class="muted">Status: {{ session_obj.get_status_display }}</p>
        </div>
        <div class="portal-actions">
            <a class="btn btn-outline small" href="{% url 'clients:assessment-manage' assessment_type %}">Back to sessions</a>
        </div>
    </section>

    <section class="panel portal-panel">
        <header>
            <div>
                <p class="eyebrow">Summary</p>
                <h2>Candidate performance</h2>
            </div>
        </header>
        <div class="portal-card-grid">
            <article class="portal-card">
                <p class="label">Score</p>
                <h2>{% if report.score %}{{ report.score|floatformat:2 }}{% elif report.overall %}{{ report.overall|floatformat:2 }}{% else %}—{% endif %}</h2>
                <p class="muted"><a href="{{ share_link }}" target="_blank">Share link</a></p>
            </article>
            {% if assessment_type == 'behavioral' and report.label %}
            <article class="portal-card">
                <p class="label">Decision</p>
                <h2>{{ report.label }}</h2>
                <p class="muted">Behavioral eligibility rating</p>
            </article>
            {% elif assessment_type != 'behavioral' %}
            <article class="portal-card">
                <p class="label">Skill mix</p>
                <h2>{{ report.hard|default:'—' }}/{{ report.soft|default:'—' }}</h2>
                <p class="muted">Hard vs. soft skill scores</p>
            </article>
            {% endif %}
            {% if report.seniority %}
            <article class="portal-card">
                <p class="label">Recommended level</p>
                <h2>{{ report.seniority }}</h2>
                <p class="muted">Suggested seniority band</p>
            </article>
            {% endif %}
        </div>
    </section>

    {% if decision_summary %}
    <section class="panel portal-panel">
        <header>
            <div>
                <p class="eyebrow">Review panel</p>
                <h2>Decision votes</h2>
            </div>
        </header>
        <div class="chip-row">
            {% for item in decision_summary %}
            <span class="chip{% if recommended_decision and recommended_decision.decision == item.decision %} emphasis{% endif %}">
                {{ item.decision|title }} · {{ item.count }}
            </span>
            {% endfor %}
        </div>
        {% if recommended_decision %}
        <p class="muted">Recommended direction: <strong>{{ recommended_decision.decision|title }}</strong></p>
        {% endif %}
    </section>
    {% endif %}

    <section class="panel portal-panel">
        {% if assessment_type == 'behavioral' %}
        <header>
            <div>
                <p class="eyebrow">Behavioral breakdown</p>
                <h2>Trait scores</h2>
            </div>
        </header>
        <div class="table">
            <div class="table-row table-head">
                <span>Trait</span>
                <span>Score</span>
            </div>
            {% for trait, score in report.traits.items %}
            <div class="table-row">
                <span>{{ trait|title }}</span>
                <span>{% if score %}{{ score|floatformat:1 }}{% else %}—{% endif %}</span>
            </div>
            {% endfor %}
        </div>
        <header>
            <div>
                <h2>Risk flags</h2>
            </div>
        </header>
        {% if report.flags %}
        <ul class="activity-list">
            {% for flag in report.flags %}
            <li>
                <div>
                    <p>{{ flag.trait|default:flag.code|title }}</p>
                    <small>{{ flag.reason }}</small>
                </div>
                <span>{{ flag.level|title }}</span>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="empty-state">No red flags triggered.</p>
        {% endif %}
        {% else %}
        <header>
            <div>
                <p class="eyebrow">Category breakdown</p>
                <h2>Skill profile</h2>
            </div>
        </header>
        <div class="table">
            <div class="table-row table-head">
                <span>Category</span>
                <span>Score</span>
            </div>
            {% for cat, value in report.categories.items %}
            <div class="table-row">
                <span>{{ cat|title }}</span>
                <span>{{ value }}</span>
            </div>
            {% endfor %}
        </div>
        <header>
            <div>
                <h2>Fit signals</h2>
            </div>
        </header>
        {% if report.fit_scores %}
        <div class="table">
            <div class="table-row table-head">
                <span>Domain</span>
                <span>Score</span>
            </div>
            {% for domain, score in report.fit_scores.items %}
            <div class="table-row">
                <span>{{ domain|title }}</span>
                <span>{{ score }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        <div class="chip-row">
            {% if report.strengths %}
            <div>
                <p class="label">Strengths</p>
                {% for item in report.strengths %}
                <span class="chip">{{ item|title }}</span>
                {% endfor %}
            </div>
            {% endif %}
            {% if report.development %}
                <div>
                    <p class="label">Development areas</p>
                    {% for item in report.development %}
                    <span class="chip warning">{{ item|title }}</span>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        {% if not report.fit_scores and not report.strengths and not report.development %}
        <p class="muted">No recommendation data recorded.</p>
        {% endif %}
        {% endif %}
    </section>

    <section class="panel portal-panel notes-panel">
        <header>
            <div>
                <p class="eyebrow">Collaboration</p>
                <h2>Candidate notes</h2>
            </div>
        </header>
        {% if can_edit_notes or can_record_decision %}
        <form method="post" class="note-form">
            {% csrf_token %}
            {{ note_form.non_field_errors }}
            <div class="form-field">
                {{ note_form.note_type.label_tag }}
                {{ note_form.note_type }}
                {% for error in note_form.note_type.errors %}
                <span class="field-error">{{ error }}</span>
                {% endfor %}
            </div>
            <div class="form-field">
                {{ note_form.decision.label_tag }}
                {{ note_form.decision }}
                {% for error in note_form.decision.errors %}
                <span class="field-error">{{ error }}</span>
                {% endfor %}
            </div>
            <div class="form-field">
                {{ note_form.note.label_tag }}
                {{ note_form.note }}
                {% for error in note_form.note.errors %}
                <span class="field-error">{{ error }}</span>
                {% endfor %}
            </div>
            <label class="note-flag">
                {{ note_form.needs_review }}
                <span>{{ note_form.needs_review.label }}</span>
            </label>
            {% for error in note_form.needs_review.errors %}
            <span class="field-error">{{ error }}</span>
            {% endfor %}
            <button class="btn btn-outline small" type="submit">Save note</button>
        </form>
        {% else %}
        <p class="muted">You have viewer access. Contact your admin to share feedback.</p>
        {% endif %}
        {% if notes %}
        <ul class="notes-list">
            {% for note in notes %}
            <li>
                <div>
                    <p class="note-meta">
                        {{ note.created_at|naturaltime }}
                        {% if note.author %}· {{ note.author.get_full_name|default:note.author.username }}{% endif %}
                        · {{ note.get_note_type_display }}
                        {% if note.decision %}· {{ note.get_decision_display }}{% endif %}
                        {% if note.author_role %}· {{ note.get_author_role_display|default:note.author_role|title }}{% endif %}
                    </p>
                    {% if note.note %}
                    <p>{{ note.note }}</p>
                    {% endif %}
                </div>
                {% if note.needs_review %}
                <span class="pill warning">Needs review</span>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="muted">No notes yet. Use the form above to capture feedback or flag follow-ups.</p>
        {% endif %}
    </section>
</div>
{% endblock %}
