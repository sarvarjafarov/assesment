{% extends 'portal_base.html' %}
{% load static %}
{% load humanize %}
{% block title %}{{ session_obj.candidate_id }} · {{ assessment_label }} · Evalon{% endblock %}
{% block meta_description %}Assessment report for {{ session_obj.candidate_id }}.{% endblock %}
{% block portal_content %}
<div class="portal-shell">

    {# ── Header ── #}
    <header class="rd-header">
        <div class="rd-header-left">
            <nav class="rd-breadcrumb">
                <a href="{% url 'clients:assessments' %}">Assessments</a>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                <a href="{% url 'clients:assessment-manage' assessment_type %}">{{ assessment_label }}</a>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                <span>{{ session_obj.candidate_id }}</span>
            </nav>
            <h1>{{ session_obj.candidate_id }}</h1>
            <div class="rd-meta">
                <span class="rd-status rd-st-{{ session_obj.status }}">{{ session_obj.get_status_display }}</span>
                {% if session_obj.submitted_at %}
                <span class="rd-meta-text">Submitted {{ session_obj.submitted_at|naturaltime }}</span>
                {% endif %}
            </div>
        </div>
        {% if share_link %}
        <a href="{{ share_link }}" target="_blank" class="btn btn-outline small">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                <polyline points="16 6 12 2 8 6"></polyline>
                <line x1="12" y1="2" x2="12" y2="15"></line>
            </svg>
            Share
        </a>
        {% endif %}
    </header>

    {# ── Recommendation Banner ── #}
    {% if actionable_summary %}
    <div class="rd-banner rd-tone-{{ actionable_summary.tone }}">
        <div class="rd-banner-left">
            <span class="rd-banner-badge">{{ actionable_summary.label }}</span>
            <h2>{{ actionable_summary.headline }}</h2>
            <p>{{ actionable_summary.subline }}</p>
        </div>
        <div class="rd-banner-chips">
            <div class="rd-chip">
                <span class="rd-chip-lbl">Score</span>
                <span class="rd-chip-val">{{ actionable_summary.metrics.score }}</span>
            </div>
            <div class="rd-chip">
                <span class="rd-chip-lbl">Risk</span>
                <span class="rd-chip-val">{{ actionable_summary.metrics.flags }}</span>
            </div>
            <div class="rd-chip">
                <span class="rd-chip-lbl">Highlight</span>
                <span class="rd-chip-val">{{ actionable_summary.metrics.strength }}</span>
            </div>
        </div>
    </div>
    {% endif %}

    {# ── Key Metrics Strip ── #}
    <div class="rd-metrics">
        <article class="rd-metric-card">
            <span class="rd-metric-lbl">Overall score</span>
            <span class="rd-metric-val">
                {% if report.score %}{{ report.score|floatformat:1 }}{% elif report.overall %}{{ report.overall|floatformat:1 }}{% else %}—{% endif %}
            </span>
            <span class="rd-metric-sub">
                {% if comparative_insights.cohort_total %}
                vs. avg {{ comparative_insights.cohort_avg|floatformat:1 }}
                {% else %}
                Final assessment score
                {% endif %}
            </span>
        </article>
        <article class="rd-metric-card">
            <span class="rd-metric-lbl">Recommendation</span>
            <span class="rd-metric-val rd-metric-text">
                {% if report.seniority %}{{ report.seniority }}{% elif report.label %}{{ report.label }}{% else %}—{% endif %}
            </span>
            <span class="rd-metric-sub">Suggested seniority level</span>
        </article>
        <article class="rd-metric-card">
            <span class="rd-metric-lbl">Ranking</span>
            <span class="rd-metric-val rd-metric-text">
                {% if comparative_insights.percentile %}Top {{ comparative_insights.percentile|floatformat:0 }}%{% else %}—{% endif %}
            </span>
            <span class="rd-metric-sub">
                {% if comparative_insights.cohort_total %}Among {{ comparative_insights.cohort_total }} candidates{% else %}No comparison data{% endif %}
            </span>
        </article>
    </div>

    {# ── Take Action ── #}
    {% if can_record_decision %}
    <section class="rd-section">
        <div class="rd-section-head">
            <h2>Take Action</h2>
            <span class="rd-section-sub">Record your hiring decision</span>
        </div>
        <div class="rd-action-card">
            <form method="post" class="rd-action-form">
                {% csrf_token %}
                <input type="hidden" name="action" value="quick_decision">
                <div class="rd-action-btns">
                    <button type="submit" name="decision" value="advance" class="rd-action rd-action--advance">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                        <div>
                            <span class="rd-action-label">Advance</span>
                            <span class="rd-action-hint">Move to next stage</span>
                        </div>
                    </button>
                    <button type="submit" name="decision" value="hold" class="rd-action rd-action--hold">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <div>
                            <span class="rd-action-label">Hold</span>
                            <span class="rd-action-hint">Need more signals</span>
                        </div>
                    </button>
                    <button type="submit" name="decision" value="reject" class="rd-action rd-action--reject">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                        <div>
                            <span class="rd-action-label">Reject</span>
                            <span class="rd-action-hint">Send decline note</span>
                        </div>
                    </button>
                </div>
                <div class="rd-action-note">
                    <label for="decision-note">Add context (optional)</label>
                    <textarea id="decision-note" name="note" rows="2" placeholder="Add next steps or notes for the candidate"></textarea>
                </div>
            </form>
        </div>
    </section>
    {% endif %}

    {# ── Timeline ── #}
    {% if activity_timeline %}
    <section class="rd-section">
        <div class="rd-section-head">
            <h2>Candidate Journey</h2>
            <span class="rd-section-sub">Key milestones and events</span>
        </div>
        <div class="rd-timeline-card">
            {% for event in activity_timeline %}
            <div class="rd-tl-event">
                <div class="rd-tl-dot"></div>
                <div class="rd-tl-body">
                    <div class="rd-tl-top">
                        <strong>{{ event.label }}</strong>
                        <span class="rd-tl-time">{{ event.timestamp|naturaltime }}</span>
                    </div>
                    <p class="rd-tl-desc">{{ event.description }}</p>
                    <span class="rd-tl-date">{{ event.timestamp|date:"M j, Y · H:i" }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    {# ── Performance Breakdown ── #}
    <section class="rd-section">
        <div class="rd-section-head">
            <h2>{% if assessment_type == 'behavioral' %}Behavioral Profile{% else %}Skill Breakdown{% endif %}</h2>
            <span class="rd-section-sub">Detailed performance analysis</span>
        </div>

        {% if assessment_type == 'behavioral' %}
        {# Trait Scores #}
        {% if report.traits %}
        <div class="rd-traits-grid">
            {% for trait, score in report.traits.items %}
            <div class="rd-trait">
                <div class="rd-trait-top">
                    <span class="rd-trait-name">{{ trait|title }}</span>
                    <span class="rd-trait-score">{% if score %}{{ score|floatformat:1 }}{% else %}—{% endif %}</span>
                </div>
                <div class="rd-trait-bar">
                    <div class="rd-trait-fill" style="width: {{ score|floatformat:0 }}%;"></div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {# Risk Flags #}
        {% if report.flags %}
        <h3 class="rd-sub-title">Risk Flags</h3>
        <div class="rd-flags-grid">
            {% for flag in report.flags %}
            <div class="rd-flag rd-flag--{{ flag.level|default:'watchlist'|lower }}">
                <div class="rd-flag-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                </div>
                <div class="rd-flag-body">
                    <strong>{{ flag.trait|default:flag.code|title }}</strong>
                    <p>{{ flag.reason }}</p>
                    <span class="rd-flag-level">{{ flag.level|default:'Watchlist'|title }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% else %}
        {# Skills Heatmap #}
        {% if report.category_heatmap %}
        <div class="rd-skills-grid">
            {% for item in report.category_heatmap %}
            <div class="rd-skill rd-skill--{{ item.status }}">
                <span class="rd-skill-lbl">{{ item.label|title }}</span>
                <span class="rd-skill-val">{% if item.score is not None %}{{ item.score|floatformat:0 }}{% else %}—{% endif %}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {# Category Scores Table #}
        {% if report.categories %}
        <div class="rd-cat-table">
            <div class="rd-cat-head">
                <span>Category</span>
                <span>Score</span>
            </div>
            {% for cat, value in report.categories.items %}
            <div class="rd-cat-row">
                <span class="rd-cat-name">{{ cat|title }}</span>
                <span class="rd-cat-score">{{ value|floatformat:1 }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {# Strengths & Development #}
        {% if report.strengths or report.development %}
        <div class="rd-strengths">
            {% if report.strengths %}
            <div class="rd-str-section">
                <h4>Strengths</h4>
                <div class="rd-chips">
                    {% for item in report.strengths %}
                    <span class="rd-tag rd-tag--good">{{ item|title }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% if report.development %}
            <div class="rd-str-section">
                <h4>Development Areas</h4>
                <div class="rd-chips">
                    {% for item in report.development %}
                    <span class="rd-tag rd-tag--warn">{{ item|title }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
        {% endif %}
    </section>

    {# ── Team Notes ── #}
    <section class="rd-section">
        <div class="rd-section-head">
            <h2>Team Notes</h2>
            <span class="rd-section-sub">Shared feedback and decisions</span>
        </div>
        <div class="rd-notes-card">
            {% if can_edit_notes or can_record_decision %}
            <form method="post" class="rd-note-form">
                {% csrf_token %}
                {{ note_form.non_field_errors }}
                <div class="rd-note-grid">
                    <div class="rd-note-field">
                        {{ note_form.note_type.label_tag }}
                        {{ note_form.note_type }}
                        {% for error in note_form.note_type.errors %}
                        <span class="rd-field-error">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="rd-note-field">
                        {{ note_form.decision.label_tag }}
                        {{ note_form.decision }}
                        {% for error in note_form.decision.errors %}
                        <span class="rd-field-error">{{ error }}</span>
                        {% endfor %}
                    </div>
                </div>
                <div class="rd-note-field">
                    {{ note_form.note.label_tag }}
                    {{ note_form.note }}
                    {% for error in note_form.note.errors %}
                    <span class="rd-field-error">{{ error }}</span>
                    {% endfor %}
                </div>
                <div class="rd-note-foot">
                    <label class="rd-checkbox">
                        {{ note_form.needs_review }}
                        <span>{{ note_form.needs_review.label }}</span>
                    </label>
                    <button type="submit" class="btn btn-primary">Save Note</button>
                </div>
            </form>
            {% endif %}

            {% if notes %}
            <div class="rd-note-list">
                {% for note in notes %}
                <div class="rd-note-item">
                    <div class="rd-note-top">
                        <div class="rd-note-who">
                            <span class="rd-note-author">
                                {% if note.author %}{{ note.author.get_full_name|default:note.author.username }}{% else %}System{% endif %}
                            </span>
                            <span class="rd-note-time">{{ note.created_at|naturaltime }}</span>
                        </div>
                        {% if note.note_type == 'decision' %}
                        <span class="rd-note-badge">{{ note.get_decision_display }}</span>
                        {% endif %}
                    </div>
                    {% if note.note %}
                    <p class="rd-note-text">{{ note.note }}</p>
                    {% endif %}
                    <div class="rd-note-info">
                        <span class="rd-note-type">{{ note.get_note_type_display }}</span>
                        {% if note.needs_review %}
                        <span class="rd-note-flag">Needs Review</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="rd-note-empty">No notes yet. Use the form above to add feedback or flag follow-ups.</p>
            {% endif %}
        </div>
    </section>

    {# ── Advanced Details ── #}
    <details class="rd-advanced">
        <summary class="rd-advanced-toggle">
            <h3>Advanced Details</h3>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
        </summary>
        <div class="rd-advanced-body">

            {# Candidate Feedback #}
            {% if candidate_feedback %}
            <div class="rd-adv-card">
                <h4>Candidate Feedback</h4>
                <div class="rd-adv-grid">
                    <div>
                        <span class="rd-adv-lbl">Rating</span>
                        <strong>{% if candidate_feedback.label %}{{ candidate_feedback.label }}{% elif candidate_feedback.score %}{{ candidate_feedback.score }}/5{% else %}—{% endif %}</strong>
                    </div>
                    <div>
                        <span class="rd-adv-lbl">Submitted</span>
                        <strong>{% if candidate_feedback.submitted_at %}{{ candidate_feedback.submitted_at|naturaltime }}{% else %}—{% endif %}</strong>
                    </div>
                </div>
                {% if candidate_feedback.comment %}
                <blockquote class="rd-feedback-quote">"{{ candidate_feedback.comment }}"</blockquote>
                {% endif %}
            </div>
            {% endif %}

            {# Integrity Signals #}
            {% if integrity_signals %}
            <div class="rd-adv-card">
                <h4>Environment Telemetry</h4>
                <div class="rd-adv-grid rd-adv-grid--3">
                    <div>
                        <span class="rd-adv-lbl">Primary IP</span>
                        <span>{{ integrity_signals.ip_address|default:"—" }}</span>
                        {% if integrity_signals.ip_switches %}
                        <span class="rd-adv-sub">{{ integrity_signals.ip_switches }} change(s)</span>
                        {% endif %}
                    </div>
                    <div>
                        <span class="rd-adv-lbl">Device</span>
                        <span class="rd-adv-sub">{{ integrity_signals.user_agent|default:"Unknown" }}</span>
                    </div>
                    <div>
                        <span class="rd-adv-lbl">Paste Events</span>
                        <span>{{ integrity_signals.paste_count }}</span>
                    </div>
                </div>
            </div>
            {% endif %}

            {# Response Drilldown #}
            {% if response_drilldown %}
            <div class="rd-adv-card">
                <h4>Response Details</h4>
                {% for item in response_drilldown|slice:":5" %}
                <details class="rd-response">
                    <summary>
                        <strong>{{ item.prompt }}</strong>
                        <span class="rd-resp-outcome rd-resp--{{ item.outcome_class }}">{{ item.outcome }}</span>
                    </summary>
                    <div class="rd-resp-body">
                        <p><strong>Answer:</strong> {{ item.answer }}</p>
                        <p><strong>Time:</strong> {{ item.elapsed }}</p>
                    </div>
                </details>
                {% endfor %}
                {% if response_drilldown|length > 5 %}
                <p class="rd-resp-more">Showing 5 of {{ response_drilldown|length }} responses</p>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </details>

</div>
{% endblock %}
