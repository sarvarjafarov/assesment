{% extends 'portal_base.html' %}
{% load static %}
{% load humanize %}
{% block title %}Jobs · Evalon{% endblock %}
{% block meta_description %}Manage your open positions and hiring campaigns.{% endblock %}
{% block portal_content %}
<div class="portal-shell">

    {# ── Page Header ── #}
    <header class="pj-header">
        <div>
            <h1>Jobs</h1>
            <p class="muted">Manage positions and hiring campaigns</p>
        </div>
        {% if is_manager %}
        <div class="pj-header-actions">
            {% if active_tab == "campaigns" %}
            <button type="button" class="btn btn-pill pj-create-btn" id="cp-toggle-create">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                New Project
            </button>
            {% else %}
            <a href="{% url 'clients:project-create' %}" class="btn btn-pill pj-create-btn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                New Position
            </a>
            {% endif %}
        </div>
        {% endif %}
    </header>

    {# ── Tabs ── #}
    <nav class="portal-tabs">
        <a href="{% url 'clients:project-list' %}" class="portal-tab {% if active_tab != 'campaigns' %}active{% endif %}">
            Positions
            {% if projects %}<span class="tab-badge">{{ projects|length }}</span>{% endif %}
        </a>
        <a href="{% url 'clients:project-list' %}?tab=campaigns" class="portal-tab {% if active_tab == 'campaigns' %}active{% endif %}">
            Campaigns
            {% if campaigns %}<span class="tab-badge">{{ campaigns|length }}</span>{% endif %}
        </a>
    </nav>

    {% if active_tab == "campaigns" %}
    {# ── CAMPAIGNS TAB ── #}

    {# ── Collapsible Create Form ── #}
    {% if is_manager %}
    <div class="cp-create-panel" id="cp-create-panel" {% if campaign_form.errors %}style="display:block"{% endif %}>
        <form method="post" class="cp-form">
            {% csrf_token %}
            <div class="cp-form-grid">
                <div class="cp-field">
                    <label for="{{ campaign_form.name.id_for_label }}">Project name</label>
                    {{ campaign_form.name }}
                    {% for error in campaign_form.name.errors %}
                    <span class="field-error">{{ error }}</span>
                    {% endfor %}
                </div>
                <div class="cp-field cp-field-wide">
                    <label for="{{ campaign_form.description.id_for_label }}">Description</label>
                    {{ campaign_form.description }}
                </div>
                <div class="cp-field cp-field-action">
                    <button type="submit" class="btn btn-primary">Create Project</button>
                </div>
            </div>
        </form>
    </div>
    {% endif %}

    {# ── Campaign Grid ── #}
    {% if campaigns %}
    <div class="cp-grid">
        {% for campaign in campaigns %}
        <a href="{% url 'clients:campaign-detail' campaign.uuid %}" class="cp-card">
            <div class="cp-card-top">
                <div class="cp-card-title">
                    <h3>{{ campaign.name }}</h3>
                    {% if campaign.description %}
                    <span class="cp-meta">{{ campaign.description|truncatewords:12 }}</span>
                    {% endif %}
                </div>
                <span class="cp-status cp-status-{{ campaign.status }}">{{ campaign.get_status_display }}</span>
            </div>

            <div class="cp-stats-row">
                <div class="cp-stat">
                    <span class="cp-stat-val">{{ campaign.pos_count }}</span>
                    <span class="cp-stat-lbl">Position{{ campaign.pos_count|pluralize }}</span>
                </div>
                <div class="cp-stat">
                    <span class="cp-stat-val">{{ campaign.active_count }}</span>
                    <span class="cp-stat-lbl">Active</span>
                </div>
            </div>

            <div class="cp-card-foot">
                <span class="cp-card-date">Created {{ campaign.created_at|naturaltime }}</span>
                <span class="cp-card-arrow">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </span>
            </div>
        </a>
        {% endfor %}
    </div>
    {% else %}
    <div class="cp-empty">
        <div class="cp-empty-icon">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
            </svg>
        </div>
        <h2>No campaigns yet</h2>
        <p>Create a campaign to group related positions under a hiring project.</p>
    </div>
    {% endif %}

    {% else %}
    {# ── POSITIONS TAB (default) ── #}

    {# ── Positions Grid ── #}
    {% if projects %}
    <div class="pj-grid">
        {% for project in projects %}
        <a href="{% url 'clients:project-detail' project.uuid %}" class="pj-card pj-priority-{{ project.priority }}">
            <div class="pj-card-top">
                <div class="pj-card-title">
                    <h3>{{ project.title }}</h3>
                    {% if project.department or project.location %}
                    <span class="pj-meta">
                        {% if project.department %}{{ project.department }}{% endif %}
                        {% if project.department and project.location %} · {% endif %}
                        {% if project.location %}{{ project.location }}{% endif %}
                    </span>
                    {% endif %}
                </div>
                <span class="pj-status pj-status-{{ project.status }}">{{ project.get_status_display }}</span>
            </div>

            {% if project.employment_type or project.work_model %}
            <div class="pj-card-tags">
                {% if project.employment_type %}
                <span class="pj-tag">{{ project.get_employment_type_display }}</span>
                {% endif %}
                {% if project.work_model %}
                <span class="pj-tag">{{ project.get_work_model_display }}</span>
                {% endif %}
            </div>
            {% endif %}

            <div class="pj-stats-row">
                <div class="pj-stat">
                    <span class="pj-stat-val">{{ project.open_roles }}</span>
                    <span class="pj-stat-lbl">Open role{{ project.open_roles|pluralize }}</span>
                </div>
                <div class="pj-stat">
                    <span class="pj-stat-val">{{ project.total_sessions }}</span>
                    <span class="pj-stat-lbl">Assessment{{ project.total_sessions|pluralize }}</span>
                </div>
                {% with health=project.health %}
                {% if health.completion_rate is not None %}
                <div class="pj-stat">
                    <span class="pj-stat-val">{{ health.completion_rate|floatformat:0 }}%</span>
                    <span class="pj-stat-lbl">Complete</span>
                </div>
                {% endif %}
                {% endwith %}
            </div>

            {% with health=project.health %}
            {% if health.completion_rate is not None %}
            <div class="pj-progress">
                <div class="pj-progress-fill" style="width: {{ health.completion_rate|floatformat:0 }}%"></div>
            </div>
            {% endif %}
            {% endwith %}

            <div class="pj-card-foot">
                <span class="pj-badge pj-badge-{{ project.priority }}">{{ project.get_priority_display }}</span>
                {% if project.assessment_type %}
                <span class="pj-tag pj-tag-assess">{{ project.get_assessment_type_display }}</span>
                {% endif %}
                {% if project.deadline %}
                <span class="pj-deadline {% if project.is_past_deadline %}pj-deadline-expired{% endif %}">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    {{ project.deadline|date:"M j, Y" }}
                </span>
                {% endif %}
                <span class="pj-date">{{ project.created_at|naturaltime }}</span>
            </div>
        </a>
        {% endfor %}
    </div>
    {% else %}
    <div class="pj-empty">
        <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.2; color: var(--color-orange); margin-bottom: 1rem;">
            <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
            <path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"></path>
        </svg>
        <h3>No positions yet</h3>
        {% if is_manager %}
        <p class="muted">Create your first position to start organizing candidates.</p>
        {% else %}
        <p class="muted">Positions will appear here once your manager creates them.</p>
        {% endif %}
    </div>
    {% endif %}

    {% endif %}

</div>

{% if active_tab == "campaigns" %}
<script>
(function() {
    const btn = document.getElementById('cp-toggle-create');
    const panel = document.getElementById('cp-create-panel');
    if (btn && panel) {
        btn.addEventListener('click', function() {
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        });
    }
})();
</script>
{% endif %}
{% endblock %}
