{% extends 'portal_base.html' %}
{% load static %}
{% load humanize %}
{% block title %}Projects · Evalon{% endblock %}
{% block meta_description %}Manage your hiring projects and candidate pipelines.{% endblock %}
{% block portal_content %}
<div class="portal-shell">

    {# ── Page Header ── #}
    <header class="pj-header">
        <div>
            <h1>Projects</h1>
            <p class="muted">Organize candidates by role and track hiring progress</p>
        </div>
        {% if is_manager %}
        <button type="button" class="btn btn-pill pj-create-btn" id="pj-toggle-create">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            New Project
        </button>
        {% endif %}
    </header>

    {# ── Collapsible Create Form ── #}
    {% if is_manager %}
    <div class="pj-create-panel" id="pj-create-panel" {% if form.errors %}style="display:block"{% endif %}>
        <form method="post" class="pj-form">
            {% csrf_token %}
            <div class="pj-form-grid">
                <div class="pj-field">
                    <label for="{{ form.title.id_for_label }}">Project title</label>
                    {{ form.title }}
                    {% for error in form.title.errors %}
                    <span class="field-error">{{ error }}</span>
                    {% endfor %}
                </div>
                <div class="pj-field">
                    <label for="{{ form.open_roles.id_for_label }}">Open roles</label>
                    {{ form.open_roles }}
                    {% for error in form.open_roles.errors %}
                    <span class="field-error">{{ error }}</span>
                    {% endfor %}
                </div>
                <div class="pj-field">
                    <label for="{{ form.priority.id_for_label }}">Priority</label>
                    {{ form.priority }}
                </div>
                <div class="pj-field pj-field-action">
                    <button type="submit" class="btn btn-primary">Create Project</button>
                </div>
            </div>
        </form>
    </div>
    {% endif %}

    {# ── Filter / Count Bar ── #}
    {% if projects %}
    <div class="pj-toolbar">
        <span class="pj-count">{{ projects|length }} project{{ projects|length|pluralize }}</span>
    </div>
    {% endif %}

    {# ── Projects Grid ── #}
    {% if projects %}
    <div class="pj-grid">
        {% for project in projects %}
        <a href="{% url 'clients:project-detail' project.uuid %}" class="pj-card pj-priority-{{ project.priority }}">
            <div class="pj-card-top">
                <div class="pj-card-title">
                    <h3>{{ project.title }}</h3>
                    {% if project.department or project.location %}
                    <span class="pj-meta">
                        {% if project.department %}{{ project.department }}{% endif %}
                        {% if project.department and project.location %} · {% endif %}
                        {% if project.location %}{{ project.location }}{% endif %}
                    </span>
                    {% endif %}
                </div>
                <span class="pj-status pj-status-{{ project.status }}">{{ project.get_status_display }}</span>
            </div>

            <div class="pj-stats-row">
                <div class="pj-stat">
                    <span class="pj-stat-val">{{ project.open_roles }}</span>
                    <span class="pj-stat-lbl">Open role{{ project.open_roles|pluralize }}</span>
                </div>
                <div class="pj-stat">
                    <span class="pj-stat-val">{{ project.total_sessions }}</span>
                    <span class="pj-stat-lbl">Assessment{{ project.total_sessions|pluralize }}</span>
                </div>
                {% with health=project.health %}
                {% if health.completion_rate is not None %}
                <div class="pj-stat">
                    <span class="pj-stat-val">{{ health.completion_rate|floatformat:0 }}%</span>
                    <span class="pj-stat-lbl">Complete</span>
                </div>
                {% endif %}
                {% endwith %}
            </div>

            {% with health=project.health %}
            {% if health.completion_rate is not None %}
            <div class="pj-progress">
                <div class="pj-progress-fill" style="width: {{ health.completion_rate|floatformat:0 }}%"></div>
            </div>
            {% endif %}
            {% endwith %}

            <div class="pj-card-foot">
                <span class="pj-badge pj-badge-{{ project.priority }}">{{ project.get_priority_display }}</span>
                <span class="pj-date">{{ project.created_at|naturaltime }}</span>
            </div>
        </a>
        {% endfor %}
    </div>
    {% else %}
    <div class="pj-empty">
        <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.2; color: var(--color-orange); margin-bottom: 1rem;">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
        </svg>
        <h3>No projects yet</h3>
        {% if is_manager %}
        <p class="muted">Create your first project to start organizing candidates by role.</p>
        {% else %}
        <p class="muted">Projects will appear here once your manager creates them.</p>
        {% endif %}
    </div>
    {% endif %}

</div>

<script>
(function() {
    const btn = document.getElementById('pj-toggle-create');
    const panel = document.getElementById('pj-create-panel');
    if (!btn || !panel) return;
    btn.addEventListener('click', function() {
        const open = panel.style.display === 'block';
        panel.style.display = open ? 'none' : 'block';
        if (!open) panel.querySelector('input')?.focus();
    });
})();
</script>
{% endblock %}
