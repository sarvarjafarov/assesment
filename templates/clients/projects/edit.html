{% extends 'portal_base.html' %}
{% load static %}
{% block title %}{% if is_create %}New Position{% else %}Edit {{ project.title }}{% endif %} · Evalon{% endblock %}
{% block meta_description %}{% if is_create %}Create a new position{% else %}Edit position details and job description{% endif %}.{% endblock %}
{% block portal_content %}
<div class="portal-shell">

    {# ── Breadcrumb ── #}
    <nav class="pe-breadcrumb">
        <a href="{% url 'clients:project-list' %}">Positions</a>
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity=".4"><polyline points="9 18 15 12 9 6"></polyline></svg>
        {% if is_create %}
        <span>New Position</span>
        {% else %}
        <a href="{% url 'clients:project-detail' project.uuid %}">{{ project.title }}</a>
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity=".4"><polyline points="9 18 15 12 9 6"></polyline></svg>
        <span>Edit</span>
        {% endif %}
    </nav>

    <header class="pe-header">
        <h1>{% if is_create %}New Position{% else %}Edit Position{% endif %}</h1>
    </header>

    <form method="post" class="pe-form">
        {% csrf_token %}

        {# ── Row 1: Basic Info + Employment ── #}
        <div class="pe-row">
            <section class="pe-section">
                <div class="pe-section-head">
                    <h2>Basic Information</h2>
                    <p>Core details about the position</p>
                </div>
                <div class="pe-grid pe-grid-2">
                    <div class="pe-field pe-field-wide">
                        <label for="{{ form.title.id_for_label }}">Position Title <span class="pe-req">*</span></label>
                        {{ form.title }}
                        {% for error in form.title.errors %}<span class="field-error">{{ error }}</span>{% endfor %}
                    </div>
                    <div class="pe-field">
                        <label for="{{ form.campaign.id_for_label }}">Project <span class="pe-req">*</span></label>
                        <div class="pe-field-with-action">
                            {{ form.campaign }}
                            <button type="button" class="pe-inline-add" id="pe-toggle-campaign" title="Create new project">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            </button>
                        </div>
                        <div class="pe-inline-create" id="pe-campaign-create" style="display:none">
                            <input type="text" id="pe-campaign-name" placeholder="Project name" class="pe-inline-input">
                            <button type="button" id="pe-campaign-save" class="btn btn-primary btn-sm">Create</button>
                            <button type="button" id="pe-campaign-cancel" class="pe-inline-cancel">Cancel</button>
                        </div>
                        {% for error in form.campaign.errors %}<span class="field-error">{{ error }}</span>{% endfor %}
                    </div>
                    <div class="pe-field">
                        <label for="{{ form.department.id_for_label }}">Department</label>
                        {{ form.department }}
                    </div>
                    <div class="pe-field">
                        <label for="{{ form.location.id_for_label }}">Location</label>
                        {{ form.location }}
                    </div>
                    <div class="pe-field">
                        <label for="{{ form.role_level.id_for_label }}">Role Level</label>
                        {{ form.role_level }}
                    </div>
                </div>
            </section>

            <section class="pe-section">
                <div class="pe-section-head">
                    <h2>Employment Details</h2>
                    <p>Type, model, and compensation</p>
                </div>
                <div class="pe-grid pe-grid-2">
                    <div class="pe-field">
                        <label for="{{ form.employment_type.id_for_label }}">Employment Type</label>
                        {{ form.employment_type }}
                    </div>
                    <div class="pe-field">
                        <label for="{{ form.work_model.id_for_label }}">Work Model</label>
                        {{ form.work_model }}
                    </div>
                    <div class="pe-field">
                        <label for="{{ form.salary_currency.id_for_label }}">Currency</label>
                        {{ form.salary_currency }}
                    </div>
                    <div class="pe-field">
                        <label for="{{ form.salary_min.id_for_label }}">Salary Min</label>
                        {{ form.salary_min }}
                    </div>
                    <div class="pe-field">
                        <label for="{{ form.salary_max.id_for_label }}">Salary Max</label>
                        {{ form.salary_max }}
                    </div>
                </div>

                <div class="pe-divider"></div>

                <div class="pe-section-head">
                    <h2>Settings</h2>
                    <p>Pipeline, visibility, and dates</p>
                </div>
                <div class="pe-grid pe-grid-2">
                    <div class="pe-field">
                        <label for="{{ form.priority.id_for_label }}">Priority</label>
                        {{ form.priority }}
                    </div>
                    <div class="pe-field">
                        <label for="{{ form.status.id_for_label }}">Status</label>
                        {{ form.status }}
                    </div>
                    <div class="pe-field">
                        <label for="{{ form.open_roles.id_for_label }}">Open Roles</label>
                        {{ form.open_roles }}
                    </div>
                    <div class="pe-field">
                        <label for="{{ form.target_start_date.id_for_label }}">Target Start Date</label>
                        {{ form.target_start_date }}
                    </div>
                    <div class="pe-field">
                        <label for="{{ form.deadline.id_for_label }}">Application Deadline</label>
                        {{ form.deadline }}
                        <span class="pe-help">Position auto-archives after this date.</span>
                    </div>
                    <div class="pe-field">
                        <label for="{{ form.assessment_type.id_for_label }}">Public Assessment</label>
                        {{ form.assessment_type }}
                    </div>
                    <div class="pe-field pe-field-check">
                        {{ form.published }}
                        <label for="{{ form.published.id_for_label }}">Published on vacancy page</label>
                    </div>
                </div>
            </section>
        </div>

        {% if account.can_use_ai_hiring %}
        {# ── AI Screening Toggle ── #}
        <div class="pe-row pe-row-full">
            <section class="pe-section pe-section-ai">
                <div class="pe-section-head">
                    <h2>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-3px;margin-right:6px;opacity:.7"><path d="M12 2a4 4 0 0 1 4 4v2a4 4 0 0 1-8 0V6a4 4 0 0 1 4-4z"/><path d="M20 21v-2a4 4 0 0 0-3-3.87"/><path d="M4 21v-2a4 4 0 0 1 3-3.87"/><circle cx="12" cy="17" r="1"/></svg>
                        AI Screening
                    </h2>
                    <p>Automatically screen candidates who apply to this position using AI</p>
                </div>

                <div class="pe-field pe-field-check pe-ai-toggle">
                    {{ form.ai_screening_enabled }}
                    <label for="{{ form.ai_screening_enabled.id_for_label }}">Enable AI Screening for this position</label>
                </div>

                <div id="pe-ai-options" class="pe-ai-options" style="display:none">
                    <div class="pe-grid pe-grid-2">
                        <div class="pe-field">
                            <label for="{{ form.ai_automation_mode.id_for_label }}">Automation Level</label>
                            {{ form.ai_automation_mode }}
                            <span class="pe-help">Controls how much AI acts autonomously vs. requiring your approval.</span>
                        </div>
                        <div class="pe-field">
                            <label>Assessments to Send</label>
                            <div class="pe-checkbox-group">
                                {{ form.ai_assessment_types }}
                            </div>
                            <span class="pe-help">Shortlisted candidates will receive these assessments automatically.</span>
                        </div>
                    </div>
                </div>
                {% for error in form.ai_screening_enabled.errors %}<span class="field-error">{{ error }}</span>{% endfor %}
                {% for error in form.ai_assessment_types.errors %}<span class="field-error">{{ error }}</span>{% endfor %}
            </section>
        </div>
        {% endif %}

        {# ── Row 2: Job Description (full width) ── #}
        <div class="pe-row pe-row-full">
            <section class="pe-section">
                <div class="pe-section-head">
                    <h2>Job Description</h2>
                    <p>Structured sections that appear on the public job posting</p>
                </div>
                <div class="pe-jd-grid">
                    <div class="pe-field">
                        <label for="{{ form.description.id_for_label }}">About the Role</label>
                        {{ form.description }}
                        <span class="pe-help">Describe the role, team context, and what makes this opportunity unique.</span>
                    </div>
                    <div class="pe-field">
                        <label for="{{ form.responsibilities.id_for_label }}">Responsibilities</label>
                        {{ form.responsibilities }}
                        <span class="pe-help">One responsibility per line. Each line becomes a bullet point.</span>
                    </div>
                    <div class="pe-field">
                        <label for="{{ form.requirements.id_for_label }}">Requirements</label>
                        {{ form.requirements }}
                        <span class="pe-help">One required qualification per line. Each line becomes a bullet point.</span>
                    </div>
                    <div class="pe-field">
                        <label for="{{ form.nice_to_haves.id_for_label }}">Nice to Haves</label>
                        {{ form.nice_to_haves }}
                        <span class="pe-help">One preferred qualification per line. Each line becomes a bullet point.</span>
                    </div>
                </div>
                <div class="pe-field" style="margin-top: 1rem;">
                    <label for="{{ form.required_skills.id_for_label }}">Skills</label>
                    {{ form.required_skills }}
                    <span class="pe-help">Comma-separated skill tags shown on the job posting.</span>
                </div>
            </section>
        </div>

        {# ── Actions ── #}
        <div class="pe-actions">
            <button type="submit" class="btn btn-primary">{% if is_create %}Create Position{% else %}Save Changes{% endif %}</button>
            <a href="{% if is_create %}{% url 'clients:project-list' %}{% else %}{% url 'clients:project-detail' project.uuid %}{% endif %}" class="btn btn-outline">Cancel</a>
        </div>
    </form>
</div>

<script>
(function() {
    const toggle = document.getElementById('pe-toggle-campaign');
    const panel = document.getElementById('pe-campaign-create');
    const nameInput = document.getElementById('pe-campaign-name');
    const saveBtn = document.getElementById('pe-campaign-save');
    const cancelBtn = document.getElementById('pe-campaign-cancel');
    const select = document.getElementById('{{ form.campaign.id_for_label }}');

    if (!toggle || !panel) return;

    toggle.addEventListener('click', function() {
        panel.style.display = 'flex';
        toggle.style.display = 'none';
        nameInput.focus();
    });

    cancelBtn.addEventListener('click', function() {
        panel.style.display = 'none';
        toggle.style.display = '';
        nameInput.value = '';
    });

    nameInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); saveBtn.click(); }
        if (e.key === 'Escape') { cancelBtn.click(); }
    });

    saveBtn.addEventListener('click', function() {
        const name = nameInput.value.trim();
        if (!name) { nameInput.focus(); return; }
        saveBtn.disabled = true;
        saveBtn.textContent = '...';

        const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const fd = new FormData();
        fd.append('name', name);
        fd.append('csrfmiddlewaretoken', csrf);

        fetch('{% url "clients:api-campaign-quick-create" %}', { method: 'POST', body: fd })
            .then(r => r.json().then(d => ({ ok: r.ok, data: d })))
            .then(({ ok, data }) => {
                if (!ok) { alert(data.error || 'Error'); return; }
                const opt = new Option(data.name, data.id, true, true);
                select.appendChild(opt);
                panel.style.display = 'none';
                toggle.style.display = '';
                nameInput.value = '';
            })
            .catch(() => alert('Network error'))
            .finally(() => { saveBtn.disabled = false; saveBtn.textContent = 'Create'; });
    });
})();

// AI Screening toggle
(function() {
    const cb = document.getElementById('{{ form.ai_screening_enabled.id_for_label }}');
    const opts = document.getElementById('pe-ai-options');
    if (!cb || !opts) return;
    function sync() { opts.style.display = cb.checked ? '' : 'none'; }
    sync();
    cb.addEventListener('change', sync);
})();
</script>
{% endblock %}
