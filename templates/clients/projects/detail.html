{% extends 'portal_base.html' %}
{% load static %}
{% load humanize %}
{% block title %}{{ project.title }} · Projects · Evalon{% endblock %}
{% block meta_description %}Manage candidates and track progress for {{ project.title }}.{% endblock %}
{% block portal_content %}
<div class="portal-shell">

    {# ── Header ── #}
    <header class="pd-header">
        <div class="pd-header-left">
            <nav class="pd-breadcrumb">
                <a href="{% url 'clients:project-list' %}">Projects</a>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                <span>{{ project.title }}</span>
            </nav>
            <h1>{{ project.title }}</h1>
            <div class="pd-badges">
                <span class="pj-status pj-status-{{ project.status }}">{{ project.get_status_display }}</span>
                <span class="pj-badge pj-badge-{{ project.priority }}">{{ project.get_priority_display }}</span>
                {% if project.department or project.location %}
                <span class="pd-location">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                    {% if project.department %}{{ project.department }}{% endif %}
                    {% if project.department and project.location %} · {% endif %}
                    {% if project.location %}{{ project.location }}{% endif %}
                </span>
                {% endif %}
            </div>
        </div>
        <div class="pd-actions">
            {% if request.user.client_account.role == 'manager' or request.user.client_account.role == 'recruiter' %}
            <a href="{% url 'clients:assessments' %}" class="btn btn-pill">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="8.5" cy="7" r="4"></circle>
                    <line x1="20" y1="8" x2="20" y2="14"></line>
                    <line x1="23" y1="11" x2="17" y2="11"></line>
                </svg>
                Invite Candidates
            </a>
            {% endif %}
            {% if request.user.client_account.role == 'manager' %}
            <a href="{% url 'clients:project-clone' project.uuid %}" class="btn btn-outline small" title="Duplicate project">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                Duplicate
            </a>
            {% endif %}
        </div>
    </header>

    {# ── Key Metrics Strip ── #}
    <div class="pd-metrics">
        <div class="pd-metric">
            <span class="pd-metric-num">{{ project.open_roles }}</span>
            <div class="pd-metric-info">
                <span class="pd-metric-lbl">Open role{{ project.open_roles|pluralize }}</span>
                <span class="pd-metric-sub">
                    {% if project.target_start_date %}Target {{ project.target_start_date|date:"M j" }}{% else %}No target date{% endif %}
                </span>
            </div>
        </div>
        <div class="pd-metric-divider"></div>
        <div class="pd-metric">
            <span class="pd-metric-num">{{ project.total_sessions }}</span>
            <div class="pd-metric-info">
                <span class="pd-metric-lbl">Total invite{{ project.total_sessions|pluralize }}</span>
                <span class="pd-metric-sub">{{ project_health.submitted }} completed</span>
            </div>
        </div>
        <div class="pd-metric-divider"></div>
        <div class="pd-metric">
            <span class="pd-metric-num {% if project_health.completion_rate is not None and project_health.completion_rate >= 70 %}pd-num-good{% elif project_health.completion_rate is not None and project_health.completion_rate >= 40 %}pd-num-mid{% endif %}">
                {% if project_health.completion_rate is not None %}{{ project_health.completion_rate|floatformat:0 }}%{% else %}—{% endif %}
            </span>
            <div class="pd-metric-info">
                <span class="pd-metric-lbl">Completion rate</span>
                <span class="pd-metric-sub">
                    {% if project_health.total > 0 %}{{ project_health.submitted }}/{{ project_health.total }} submitted{% else %}No invites yet{% endif %}
                </span>
            </div>
        </div>
    </div>

    {# ── Description ── #}
    {% if project.description %}
    <div class="pd-description">
        <p>{{ project.description }}</p>
    </div>
    {% endif %}

    {# ── Pipeline Board ── #}
    <section class="pd-section">
        <div class="pd-section-head">
            <h2>Candidate Pipeline</h2>
            {% if can_edit_pipeline %}
            <span class="pd-hint">Update stages with the dropdown on each card</span>
            {% endif %}
        </div>
        <div class="pd-pipeline">
            {% for column in pipeline_columns %}
            <div class="pd-col">
                <div class="pd-col-head">
                    <span class="pd-col-title">{{ column.label }}</span>
                    <span class="pd-col-count">{{ column.count }}</span>
                </div>
                <div class="pd-col-body">
                    {% if column.sessions %}
                    {% for card in column.sessions %}
                    <div class="pd-pipe-card">
                        <div class="pd-pipe-top">
                            <span class="pd-pipe-name">{{ card.candidate }}</span>
                            {% if card.score %}
                            <span class="pd-pipe-score">{{ card.score|floatformat:0 }}</span>
                            {% endif %}
                        </div>
                        <span class="pd-pipe-assess">{{ card.assessment }}</span>
                        <span class="pd-pipe-time">{{ card.updated_at|naturaltime }}</span>
                        <div class="pd-pipe-foot">
                            {% if card.detail_url %}
                            <a href="{{ card.detail_url }}" class="pd-pipe-link">View Report →</a>
                            {% endif %}
                            {% if can_edit_pipeline %}
                            <form method="post" action="{{ card.stage_url }}" class="pd-stage-form">
                                {% csrf_token %}
                                <select name="stage" class="pd-stage-select" aria-label="Update stage" onchange="this.form.submit()">
                                    {% for value,label in pipeline_stage_choices %}
                                    <option value="{{ value }}" {% if value == card.stage %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="pd-col-empty">No candidates</div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </section>

    {# ── Assessment Breakdown ── #}
    {% if assessment_details %}
    <section class="pd-section">
        <div class="pd-section-head">
            <h2>Assessment Breakdown</h2>
        </div>
        <div class="pd-assess-grid">
            {% for row in assessment_details %}
            <div class="pd-assess-card">
                <div class="pd-assess-top">
                    <span class="pd-assess-label">{{ row.label }}</span>
                    <span class="pd-assess-total">{{ row.total }}</span>
                </div>
                {% if row.total > 0 %}
                <div class="pd-assess-bar">
                    <div class="pd-assess-fill" style="width: {% widthratio row.submitted row.total 100 %}%"></div>
                </div>
                {% endif %}
                <div class="pd-assess-stats">
                    <span>{{ row.submitted }} completed</span>
                    <span>{{ row.in_progress }} in progress</span>
                    <span>{{ row.draft }} draft</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    {# ── Recent Activity ── #}
    {% if recent_sessions %}
    <section class="pd-section">
        <div class="pd-section-head">
            <h2>Recent Activity</h2>
        </div>
        <div class="pd-table-wrap">
            <table class="pd-table">
                <thead>
                    <tr>
                        <th>Candidate</th>
                        <th>Assessment</th>
                        <th>Level</th>
                        <th>Status</th>
                        <th>Updated</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in recent_sessions %}
                    <tr>
                        <td class="pd-cell-name">{{ row.candidate }}</td>
                        <td>{{ row.assessment }}</td>
                        <td><span class="pd-level pd-level-{{ row.level }}">{{ row.level_display }}</span></td>
                        <td><span class="pd-status-pill pd-st-{{ row.status|slugify }}">{{ row.status }}</span></td>
                        <td class="pd-cell-muted">{{ row.updated_at|naturaltime }}</td>
                        <td class="pd-cell-action">
                            {% if row.detail_url %}
                            <a href="{{ row.detail_url }}" class="pd-report-link">Report →</a>
                            {% else %}
                            <span class="pd-cell-muted">—</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
    {% else %}
    {# ── Empty State ── #}
    <div class="pd-empty">
        <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.2; color: var(--color-orange); margin-bottom: 1rem;">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="8.5" cy="7" r="4"></circle>
            <line x1="20" y1="8" x2="20" y2="14"></line>
            <line x1="23" y1="11" x2="17" y2="11"></line>
        </svg>
        <h3>Ready to add candidates?</h3>
        <p class="muted">Invite candidates to take an assessment for this project.</p>
        {% if request.user.client_account.role == 'manager' or request.user.client_account.role == 'recruiter' %}
        <a href="{% url 'clients:assessments' %}" class="btn btn-pill" style="margin-top: 1.25rem;">Invite Candidates</a>
        {% endif %}
    </div>
    {% endif %}

</div>
{% endblock %}
