{% extends 'portal_base.html' %}
{% load humanize %}
{% block title %}{{ pipeline.title }} · AI Hiring · Evalon{% endblock %}

{% block portal_content %}
<style>
    /* ── Layout ── */
    .pd-back {
        display: inline-flex; align-items: center; gap: 0.35rem;
        color: var(--color-text-muted, #5b647b);
        text-decoration: none; font-size: 0.85rem; font-weight: 600;
        margin-bottom: 1rem; transition: color 0.2s;
    }
    .pd-back:hover { color: var(--color-orange, #ff8a00); }

    /* ── Header ── */
    .pd-header {
        display: flex; align-items: center; justify-content: space-between;
        flex-wrap: wrap; gap: 1rem; margin-bottom: 2rem;
    }
    .pd-header-left { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
    .pd-header-left h1 { margin: 0; font-size: 1.6rem; font-weight: 800; color: var(--color-text, #0e1428); }
    .pd-status {
        display: inline-flex; align-items: center;
        padding: 0.25rem 0.8rem; border-radius: 999px;
        font-size: 0.72rem; font-weight: 700;
        text-transform: uppercase; letter-spacing: 0.04em;
    }
    .pd-status--active { background: rgba(16, 185, 129, 0.12); color: #059669; }
    .pd-status--paused { background: rgba(245, 158, 11, 0.12); color: #d97706; }
    .pd-status--draft { background: rgba(14, 20, 40, 0.06); color: var(--color-text-muted, #5b647b); }
    .pd-status--completed { background: rgba(59, 130, 246, 0.12); color: #2563eb; }

    .pd-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .pd-btn {
        display: inline-flex; align-items: center; gap: 0.4rem;
        padding: 0.55rem 1.1rem; border-radius: 999px;
        font-size: 0.85rem; font-weight: 600;
        text-decoration: none; cursor: pointer;
        border: 1px solid rgba(14, 20, 40, 0.12);
        background: #fff; color: var(--color-text, #0e1428);
        transition: all 0.2s;
    }
    .pd-btn:hover { background: var(--color-bg-muted, #f7f8fb); border-color: rgba(14, 20, 40, 0.18); }
    .pd-btn--primary {
        background: var(--color-orange, #ff8a00); color: #fff;
        border-color: var(--color-orange, #ff8a00);
    }
    .pd-btn--primary:hover { background: #e67a00; border-color: #e67a00; }

    /* ── Stats ── */
    .pd-stats {
        display: grid; grid-template-columns: repeat(4, 1fr);
        gap: 1rem; margin-bottom: 2rem;
    }
    @media (max-width: 768px) { .pd-stats { grid-template-columns: repeat(2, 1fr); } }
    .pd-stat {
        background: #fff;
        border: 1px solid rgba(14, 20, 40, 0.08);
        border-radius: var(--radius-xl, 16px);
        padding: 1.5rem;
        text-align: center;
        transition: box-shadow 0.2s;
    }
    .pd-stat:hover { box-shadow: 0 8px 24px rgba(14, 20, 40, 0.06); }
    .pd-stat-icon {
        width: 36px; height: 36px;
        border-radius: 10px; margin: 0 auto 0.75rem;
        display: flex; align-items: center; justify-content: center;
    }
    .pd-stat-icon svg { width: 18px; height: 18px; }
    .pd-stat-val { font-size: 2rem; font-weight: 800; color: var(--color-text, #0e1428); line-height: 1; }
    .pd-stat-label {
        font-size: 0.72rem; font-weight: 700; color: var(--color-text-muted, #5b647b);
        text-transform: uppercase; letter-spacing: 0.05em; margin-top: 0.35rem;
    }

    /* ── Upload ── */
    .pd-upload {
        background: #fff;
        border: 1px solid rgba(14, 20, 40, 0.08);
        border-radius: var(--radius-2xl, 24px);
        padding: 1.75rem;
        margin-bottom: 2rem;
    }
    .pd-upload-header { display: flex; align-items: center; gap: 0.6rem; margin-bottom: 1rem; }
    .pd-upload-header h2 { margin: 0; font-size: 1rem; font-weight: 700; color: var(--color-text, #0e1428); }
    .pd-upload-icon {
        width: 32px; height: 32px; border-radius: 8px;
        background: rgba(255, 138, 0, 0.08);
        display: flex; align-items: center; justify-content: center;
        color: var(--color-orange, #ff8a00);
    }
    .pd-upload-form { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
    .pd-upload-form input[type="file"] {
        flex: 1; min-width: 220px;
        padding: 0.6rem 0.8rem;
        border: 2px dashed rgba(14, 20, 40, 0.12);
        border-radius: var(--radius-lg, 12px);
        font-size: 0.85rem; color: var(--color-text, #0e1428);
        background: var(--color-bg-muted, #f7f8fb);
        cursor: pointer;
        transition: border-color 0.2s, background 0.2s;
    }
    .pd-upload-form input[type="file"]:hover {
        border-color: var(--color-orange, #ff8a00);
        background: rgba(255, 138, 0, 0.03);
    }
    .pd-upload-hint { font-size: 0.78rem; color: var(--color-text-muted, #5b647b); margin-top: 0.6rem; }

    /* ── Kanban ── */
    .pd-pipeline-header { display: flex; align-items: center; gap: 0.6rem; margin-bottom: 1.25rem; }
    .pd-pipeline-header h2 { margin: 0; font-size: 1.1rem; font-weight: 700; color: var(--color-text, #0e1428); }
    .pd-pipeline-header .pd-pipeline-count {
        font-size: 0.75rem; font-weight: 700; color: var(--color-text-muted, #5b647b);
        background: var(--color-bg-muted, #f7f8fb);
        padding: 0.15rem 0.6rem; border-radius: 999px;
    }

    .pd-board {
        display: flex; gap: 0.75rem;
        overflow-x: auto; padding-bottom: 1rem;
        scrollbar-width: thin;
    }
    .pd-board::-webkit-scrollbar { height: 6px; }
    .pd-board::-webkit-scrollbar-track { background: transparent; }
    .pd-board::-webkit-scrollbar-thumb { background: rgba(14, 20, 40, 0.12); border-radius: 3px; }

    .pd-col {
        min-width: 230px; max-width: 260px;
        flex-shrink: 0;
        background: var(--color-bg-muted, #f7f8fb);
        border-radius: var(--radius-xl, 16px);
        padding: 0.75rem;
    }
    .pd-col-head {
        display: flex; align-items: center; justify-content: space-between;
        margin-bottom: 0.75rem; padding-bottom: 0.6rem;
        border-bottom: 3px solid #e2e8f0;
    }
    .pd-col-name {
        font-size: 0.72rem; font-weight: 700;
        color: var(--color-text, #0e1428);
        text-transform: uppercase; letter-spacing: 0.04em;
    }
    .pd-col-count {
        font-size: 0.68rem; font-weight: 700; color: #fff;
        border-radius: 999px;
        padding: 0.1rem 0.5rem; min-width: 1.2rem; text-align: center;
    }

    /* Stage colors */
    .pd-col[data-stage="uploaded"] .pd-col-head { border-bottom-color: #6b7280; }
    .pd-col[data-stage="uploaded"] .pd-col-count { background: #6b7280; }
    .pd-col[data-stage="screening"] .pd-col-head { border-bottom-color: #3b82f6; }
    .pd-col[data-stage="screening"] .pd-col-count { background: #3b82f6; }
    .pd-col[data-stage="shortlisted"] .pd-col-head { border-bottom-color: #10b981; }
    .pd-col[data-stage="shortlisted"] .pd-col-count { background: #10b981; }
    .pd-col[data-stage="rejected_at_screen"] .pd-col-head { border-bottom-color: #ef4444; }
    .pd-col[data-stage="rejected_at_screen"] .pd-col-count { background: #ef4444; }
    .pd-col[data-stage="assessment_pending"] .pd-col-head { border-bottom-color: #f59e0b; }
    .pd-col[data-stage="assessment_pending"] .pd-col-count { background: #f59e0b; }
    .pd-col[data-stage="assessment_sent"] .pd-col-head { border-bottom-color: #8b5cf6; }
    .pd-col[data-stage="assessment_sent"] .pd-col-count { background: #8b5cf6; }
    .pd-col[data-stage="assessment_completed"] .pd-col-head { border-bottom-color: #06b6d4; }
    .pd-col[data-stage="assessment_completed"] .pd-col-count { background: #06b6d4; }
    .pd-col[data-stage="decision_made"] .pd-col-head { border-bottom-color: #f97316; }
    .pd-col[data-stage="decision_made"] .pd-col-count { background: #f97316; }
    .pd-col[data-stage="hired"] .pd-col-head { border-bottom-color: #22c55e; }
    .pd-col[data-stage="hired"] .pd-col-count { background: #22c55e; }
    .pd-col[data-stage="rejected"] .pd-col-head { border-bottom-color: #dc2626; }
    .pd-col[data-stage="rejected"] .pd-col-count { background: #dc2626; }

    .pd-card {
        border: 1px solid rgba(14, 20, 40, 0.08);
        border-radius: var(--radius-lg, 12px);
        padding: 0.85rem;
        background: #fff;
        margin-bottom: 0.5rem;
        transition: box-shadow 0.15s, transform 0.15s;
    }
    .pd-card:hover {
        box-shadow: 0 4px 12px rgba(14, 20, 40, 0.08);
        transform: translateY(-1px);
    }
    .pd-card-name {
        font-size: 0.85rem; font-weight: 700;
        color: var(--color-text, #0e1428); margin-bottom: 0.2rem;
    }
    .pd-card-name a { color: inherit; text-decoration: none; }
    .pd-card-name a:hover { color: var(--color-orange, #ff8a00); }
    .pd-card-email {
        font-size: 0.72rem; color: var(--color-text-muted, #5b647b);
        margin-bottom: 0.4rem; word-break: break-all;
    }
    .pd-card-scores { display: flex; gap: 0.35rem; flex-wrap: wrap; }
    .pd-score {
        font-size: 0.68rem; font-weight: 700;
        padding: 0.15rem 0.45rem;
        border-radius: var(--radius-sm, 6px);
        background: var(--color-bg-muted, #f7f8fb);
        color: var(--color-text-muted, #5b647b);
        border: 1px solid rgba(14, 20, 40, 0.06);
    }
    .pd-empty-col {
        font-size: 0.75rem; color: #94a3b8;
        text-align: center; padding: 1.5rem 0.5rem;
        font-style: italic;
    }
</style>

<div class="portal-shell">

    <a href="{% url 'hiring_agent:pipeline-list' %}" class="pd-back">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg>
        All Pipelines
    </a>

    {# ── 1. Header ── #}
    <div class="pd-header">
        <div class="pd-header-left">
            <h1>{{ pipeline.title }}</h1>
            <span class="pd-status pd-status--{{ pipeline.status }}">{{ pipeline.get_status_display }}</span>
        </div>
        <div class="pd-actions">
            <a href="{% url 'hiring_agent:pipeline-edit' pipeline_uuid=pipeline.uuid %}" class="pd-btn">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                Edit
            </a>
            <form method="post" action="{% url 'hiring_agent:pipeline-pause' pipeline_uuid=pipeline.uuid %}" style="margin: 0;">
                {% csrf_token %}
                <button type="submit" class="pd-btn">
                    {% if pipeline.status == 'paused' %}
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                    Resume
                    {% else %}
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
                    Pause
                    {% endif %}
                </button>
            </form>
            <form method="post" action="{% url 'hiring_agent:pipeline-process' pipeline_uuid=pipeline.uuid %}" style="margin: 0;">
                {% csrf_token %}
                <button type="submit" class="pd-btn pd-btn--primary">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="13 17 18 12 13 7"></polyline><polyline points="6 17 11 12 6 7"></polyline></svg>
                    Process
                </button>
            </form>
        </div>
    </div>

    {# ── 2. Stats ── #}
    <div class="pd-stats">
        <div class="pd-stat">
            <div class="pd-stat-icon" style="background: rgba(14, 20, 40, 0.06);">
                <svg viewBox="0 0 24 24" fill="none" stroke="#0e1428" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
            </div>
            <div class="pd-stat-val">{{ total_candidates }}</div>
            <div class="pd-stat-label">Total</div>
        </div>
        <div class="pd-stat">
            <div class="pd-stat-icon" style="background: rgba(16, 185, 129, 0.1);">
                <svg viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
            </div>
            <div class="pd-stat-val">{{ stage_groups.shortlisted.count|default:"0" }}</div>
            <div class="pd-stat-label">Shortlisted</div>
        </div>
        <div class="pd-stat">
            <div class="pd-stat-icon" style="background: rgba(139, 92, 246, 0.1);">
                <svg viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
            </div>
            <div class="pd-stat-val">{{ stage_groups.assessment_sent.count|default:"0" }}</div>
            <div class="pd-stat-label">Assessments</div>
        </div>
        <div class="pd-stat">
            <div class="pd-stat-icon" style="background: rgba(34, 197, 94, 0.1);">
                <svg viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
            </div>
            <div class="pd-stat-val">{{ stage_groups.hired.count|default:"0" }}</div>
            <div class="pd-stat-label">Hired</div>
        </div>
    </div>

    {# ── 3. Upload ── #}
    <div class="pd-upload">
        <div class="pd-upload-header">
            <div class="pd-upload-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
            </div>
            <h2>Upload Resumes</h2>
        </div>
        <form method="post" enctype="multipart/form-data" action="{% url 'hiring_agent:resume-upload' pipeline_uuid=pipeline.uuid %}" class="pd-upload-form">
            {% csrf_token %}
            {{ upload_form.resumes }}
            <button type="submit" class="pd-btn pd-btn--primary">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                Upload
            </button>
        </form>
        <div class="pd-upload-hint">Accepted: PDF, DOCX. Multiple files supported. Email will be extracted from each resume.</div>
    </div>

    {# ── 4. Pipeline Board ── #}
    <div class="pd-pipeline-header">
        <h2>Candidate Pipeline</h2>
        <span class="pd-pipeline-count">{{ total_candidates }} total</span>
    </div>

    <div class="pd-board">
        {% for stage_code, group in stage_groups.items %}
            {% if group.count > 0 %}
            <div class="pd-col" data-stage="{{ stage_code }}">
                <div class="pd-col-head">
                    <span class="pd-col-name">{{ group.label }}</span>
                    <span class="pd-col-count">{{ group.count }}</span>
                </div>

                {% for c in group.candidates %}
                <div class="pd-card">
                    <div class="pd-card-name">
                        <a href="{% url 'hiring_agent:candidate-detail' pipeline_uuid=pipeline.uuid pk=c.pk %}">
                            {{ c.candidate.first_name }} {{ c.candidate.last_name }}
                        </a>
                    </div>
                    <div class="pd-card-email">{{ c.candidate.email }}</div>
                    <div class="pd-card-scores">
                        {% if c.ai_screen_score is not None %}
                            <span class="pd-score">Screen: {{ c.ai_screen_score }}</span>
                        {% endif %}
                        {% if c.ai_final_score is not None %}
                            <span class="pd-score">Final: {{ c.ai_final_score }}</span>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <div class="pd-empty-col">No candidates</div>
                {% endfor %}
            </div>
            {% endif %}
        {% endfor %}

        {% if total_candidates == 0 %}
        <div style="text-align: center; padding: 3rem 2rem; width: 100%; color: var(--color-text-muted, #5b647b);">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.15; margin-bottom: 0.75rem; display: block; margin-left: auto; margin-right: auto;">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle>
                <line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line>
            </svg>
            <p style="margin: 0; font-size: 0.9rem;">Upload resumes to get started</p>
        </div>
        {% endif %}
    </div>

</div>
{% endblock %}
