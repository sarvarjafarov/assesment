{% extends 'portal_base.html' %}
{% block title %}{% if is_edit %}Edit Pipeline{% else %}Create Pipeline{% endif %} · Evalon{% endblock %}
{% block portal_content %}
<style>
    .ha-back {
        display: inline-flex; align-items: center; gap: 0.35rem;
        color: var(--color-text-muted, #5b647b);
        text-decoration: none; font-size: 0.85rem; font-weight: 600;
        margin-bottom: 1.25rem;
        transition: color 0.2s;
    }
    .ha-back:hover { color: var(--color-orange, #ff8a00); }
    .ha-form-title { font-size: 1.6rem; font-weight: 800; color: var(--color-text, #0e1428); margin: 0 0 1.75rem; }

    /* ── Two-column layout ── */
    .ha-layout {
        display: grid;
        grid-template-columns: 1fr 320px;
        gap: 1.5rem;
        align-items: start;
    }
    @media (max-width: 960px) {
        .ha-layout { grid-template-columns: 1fr; }
        .ha-sidebar { order: -1; }
    }

    .ha-form-card {
        background: #fff;
        border: 1px solid rgba(14, 20, 40, 0.08);
        border-radius: var(--radius-2xl, 24px);
        padding: 2.25rem;
    }

    .ha-section-label {
        font-size: 0.75rem; font-weight: 700; color: var(--color-orange, #ff8a00);
        text-transform: uppercase; letter-spacing: 0.08em;
        margin: 2rem 0 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(14, 20, 40, 0.06);
    }
    .ha-section-label:first-of-type { margin-top: 0; }

    .ha-field { margin-bottom: 1.25rem; }
    .ha-field label {
        display: block; font-weight: 600; font-size: 0.9rem;
        color: var(--color-text, #0e1428); margin-bottom: 0.4rem;
    }
    .ha-field input[type="text"],
    .ha-field input[type="number"],
    .ha-field textarea,
    .ha-field select {
        width: 100%; box-sizing: border-box;
        padding: 0.7rem 0.9rem;
        border: 1px solid rgba(14, 20, 40, 0.12);
        border-radius: var(--radius-md, 8px);
        font-size: 0.9rem; font-family: inherit;
        color: var(--color-text, #0e1428);
        background: var(--color-bg, #fff);
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    .ha-field input:focus,
    .ha-field textarea:focus,
    .ha-field select:focus {
        outline: none;
        border-color: var(--color-orange, #ff8a00);
        box-shadow: 0 0 0 3px rgba(255, 138, 0, 0.12);
    }
    .ha-field textarea { resize: vertical; min-height: 100px; }
    .ha-field .ha-help { font-size: 0.78rem; color: var(--color-text-muted, #5b647b); margin-top: 0.3rem; line-height: 1.4; }
    .ha-field .ha-errors { color: #dc2626; font-size: 0.82rem; margin-top: 0.3rem; }
    .ha-field .ha-errors ul { margin: 0; padding: 0 0 0 1.2rem; }

    .ha-non-field-errors {
        background: #fef2f2; border: 1px solid rgba(220, 38, 38, 0.2);
        color: #dc2626; border-radius: var(--radius-lg, 12px);
        padding: 0.75rem 1rem; margin-bottom: 1.5rem; font-size: 0.88rem;
    }
    .ha-non-field-errors ul { margin: 0; padding: 0 0 0 1.2rem; }

    .ha-checkbox-group { display: flex; flex-direction: column; gap: 0.5rem; }
    .ha-checkbox-group label {
        font-weight: 500; color: #334155;
        display: flex; align-items: center; gap: 0.5rem;
        cursor: pointer; font-size: 0.88rem;
        padding: 0.5rem 0.75rem;
        border-radius: var(--radius-md, 8px);
        border: 1px solid rgba(14, 20, 40, 0.08);
        transition: background 0.15s, border-color 0.15s;
    }
    .ha-checkbox-group label:hover { background: var(--color-bg-muted, #f7f8fb); border-color: rgba(14, 20, 40, 0.12); }
    .ha-checkbox-group input[type="checkbox"] { width: auto; accent-color: var(--color-orange, #ff8a00); }

    .ha-form-actions { margin-top: 2rem; display: flex; gap: 0.75rem; }

    .ha-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    @media (max-width: 600px) { .ha-row { grid-template-columns: 1fr; } }

    /* ── Sidebar ── */
    .ha-sidebar { display: flex; flex-direction: column; gap: 1.25rem; }
    .ha-tip {
        background: #fff;
        border: 1px solid rgba(14, 20, 40, 0.08);
        border-radius: var(--radius-xl, 16px);
        padding: 1.25rem;
    }
    .ha-tip-header {
        display: flex; align-items: center; gap: 0.5rem;
        margin-bottom: 0.75rem;
    }
    .ha-tip-icon {
        width: 28px; height: 28px; border-radius: 7px;
        display: flex; align-items: center; justify-content: center;
        flex-shrink: 0;
    }
    .ha-tip-title { font-size: 0.85rem; font-weight: 700; color: var(--color-text, #0e1428); margin: 0; }
    .ha-tip p {
        margin: 0; font-size: 0.8rem; color: var(--color-text-muted, #5b647b);
        line-height: 1.6;
    }
    .ha-tip ul {
        margin: 0.5rem 0 0; padding: 0 0 0 1.1rem;
        font-size: 0.8rem; color: var(--color-text-muted, #5b647b); line-height: 1.8;
    }

    .ha-flow {
        background: #fff;
        border: 1px solid rgba(14, 20, 40, 0.08);
        border-radius: var(--radius-xl, 16px);
        padding: 1.25rem;
    }
    .ha-flow-title {
        font-size: 0.75rem; font-weight: 700; color: var(--color-orange, #ff8a00);
        text-transform: uppercase; letter-spacing: 0.06em;
        margin: 0 0 1rem;
    }
    .ha-flow-step {
        display: flex; gap: 0.65rem;
        padding-bottom: 0.85rem; margin-bottom: 0.85rem;
        border-bottom: 1px solid rgba(14, 20, 40, 0.05);
    }
    .ha-flow-step:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .ha-flow-num {
        width: 22px; height: 22px; border-radius: 50%;
        background: rgba(255, 138, 0, 0.1); color: var(--color-orange, #ff8a00);
        font-size: 0.7rem; font-weight: 800;
        display: flex; align-items: center; justify-content: center;
        flex-shrink: 0; margin-top: 0.1rem;
    }
    .ha-flow-text { font-size: 0.8rem; color: var(--color-text-muted, #5b647b); line-height: 1.4; }
    .ha-flow-text strong { color: var(--color-text, #0e1428); font-weight: 600; }
</style>

<div class="portal-shell">

    <a href="{% url 'hiring_agent:pipeline-list' %}" class="ha-back">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg>
        Back to Pipelines
    </a>

    <h1 class="ha-form-title">
        {% if is_edit %}Edit: {{ pipeline.title }}{% else %}Create Pipeline{% endif %}
    </h1>

    <div class="ha-layout">

        {# ── Left: Form ── #}
        <div class="ha-form-card">
            <form method="post">
                {% csrf_token %}

                {% if form.non_field_errors %}
                <div class="ha-non-field-errors">{{ form.non_field_errors }}</div>
                {% endif %}

                {# ── Linked Position ── #}
                <div class="ha-section-label">Linked Position</div>

                <div class="ha-field">
                    <label for="{{ form.project.id_for_label }}">{{ form.project.label }}</label>
                    {{ form.project }}
                    <p class="ha-help">Select a position to auto-fill title, description, and skills.</p>
                    {% if form.project.errors %}<div class="ha-errors">{{ form.project.errors }}</div>{% endif %}
                </div>

                {# ── Job Details ── #}
                <div class="ha-section-label">Job Details</div>

                <div class="ha-field">
                    <label for="{{ form.title.id_for_label }}">{{ form.title.label }}</label>
                    {{ form.title }}
                    {% if form.title.help_text %}<p class="ha-help">{{ form.title.help_text }}</p>{% endif %}
                    {% if form.title.errors %}<div class="ha-errors">{{ form.title.errors }}</div>{% endif %}
                </div>

                <div class="ha-field">
                    <label for="{{ form.job_description.id_for_label }}">{{ form.job_description.label }}</label>
                    {{ form.job_description }}
                    {% if form.job_description.help_text %}<p class="ha-help">{{ form.job_description.help_text }}</p>{% endif %}
                    {% if form.job_description.errors %}<div class="ha-errors">{{ form.job_description.errors }}</div>{% endif %}
                </div>

                <div class="ha-row">
                    <div class="ha-field">
                        <label for="{{ form.experience_range.id_for_label }}">{{ form.experience_range.label }}</label>
                        {{ form.experience_range }}
                        {% if form.experience_range.help_text %}<p class="ha-help">{{ form.experience_range.help_text }}</p>{% endif %}
                        {% if form.experience_range.errors %}<div class="ha-errors">{{ form.experience_range.errors }}</div>{% endif %}
                    </div>
                    <div class="ha-field">
                        <label for="{{ form.seniority_level.id_for_label }}">{{ form.seniority_level.label }}</label>
                        {{ form.seniority_level }}
                        {% if form.seniority_level.help_text %}<p class="ha-help">{{ form.seniority_level.help_text }}</p>{% endif %}
                        {% if form.seniority_level.errors %}<div class="ha-errors">{{ form.seniority_level.errors }}</div>{% endif %}
                    </div>
                </div>

                {# ── Skills ── #}
                <div class="ha-section-label">Skills</div>

                <div class="ha-field">
                    <label for="{{ form.required_skills_text.id_for_label }}">{{ form.required_skills_text.label }}</label>
                    {{ form.required_skills_text }}
                    {% if form.required_skills_text.help_text %}<p class="ha-help">{{ form.required_skills_text.help_text }}</p>{% endif %}
                    {% if form.required_skills_text.errors %}<div class="ha-errors">{{ form.required_skills_text.errors }}</div>{% endif %}
                </div>

                <div class="ha-field">
                    <label for="{{ form.preferred_skills_text.id_for_label }}">{{ form.preferred_skills_text.label }}</label>
                    {{ form.preferred_skills_text }}
                    {% if form.preferred_skills_text.help_text %}<p class="ha-help">{{ form.preferred_skills_text.help_text }}</p>{% endif %}
                    {% if form.preferred_skills_text.errors %}<div class="ha-errors">{{ form.preferred_skills_text.errors }}</div>{% endif %}
                </div>

                {# ── Assessment Configuration ── #}
                <div class="ha-section-label">Assessment Configuration</div>

                <div class="ha-field">
                    <label>{{ form.assessment_types.label }}</label>
                    <div class="ha-checkbox-group">{{ form.assessment_types }}</div>
                    {% if form.assessment_types.help_text %}<p class="ha-help">{{ form.assessment_types.help_text }}</p>{% endif %}
                    {% if form.assessment_types.errors %}<div class="ha-errors">{{ form.assessment_types.errors }}</div>{% endif %}
                </div>

                <div class="ha-field">
                    <label for="{{ form.automation_mode.id_for_label }}">{{ form.automation_mode.label }}</label>
                    {{ form.automation_mode }}
                    {% if form.automation_mode.help_text %}<p class="ha-help">{{ form.automation_mode.help_text }}</p>{% endif %}
                    {% if form.automation_mode.errors %}<div class="ha-errors">{{ form.automation_mode.errors }}</div>{% endif %}
                </div>

                {# ── Thresholds ── #}
                <div class="ha-section-label">Thresholds</div>

                <div class="ha-row">
                    <div class="ha-field">
                        <label for="{{ form.screening_threshold.id_for_label }}">{{ form.screening_threshold.label }}</label>
                        {{ form.screening_threshold }}
                        {% if form.screening_threshold.help_text %}<p class="ha-help">{{ form.screening_threshold.help_text }}</p>{% endif %}
                        {% if form.screening_threshold.errors %}<div class="ha-errors">{{ form.screening_threshold.errors }}</div>{% endif %}
                    </div>
                    <div class="ha-field">
                        <label for="{{ form.passing_score.id_for_label }}">{{ form.passing_score.label }}</label>
                        {{ form.passing_score }}
                        {% if form.passing_score.help_text %}<p class="ha-help">{{ form.passing_score.help_text }}</p>{% endif %}
                        {% if form.passing_score.errors %}<div class="ha-errors">{{ form.passing_score.errors }}</div>{% endif %}
                    </div>
                </div>

                <div class="ha-field">
                    <label for="{{ form.max_candidates.id_for_label }}">{{ form.max_candidates.label }}</label>
                    {{ form.max_candidates }}
                    {% if form.max_candidates.help_text %}<p class="ha-help">{{ form.max_candidates.help_text }}</p>{% endif %}
                    {% if form.max_candidates.errors %}<div class="ha-errors">{{ form.max_candidates.errors }}</div>{% endif %}
                </div>

                <div class="ha-form-actions">
                    <button type="submit" class="btn btn-pill">
                        {% if is_edit %}Save Changes{% else %}Create Pipeline{% endif %}
                    </button>
                    <a href="{% url 'hiring_agent:pipeline-list' %}" class="btn btn-outline btn-pill">Cancel</a>
                </div>
            </form>
        </div>

        {# ── Right: Sidebar ── #}
        <aside class="ha-sidebar">

            {# Pipeline Flow #}
            <div class="ha-flow">
                <h4 class="ha-flow-title">How it works</h4>
                <div class="ha-flow-step">
                    <span class="ha-flow-num">1</span>
                    <span class="ha-flow-text"><strong>Upload Resumes</strong> — PDF or DOCX files with candidate info</span>
                </div>
                <div class="ha-flow-step">
                    <span class="ha-flow-num">2</span>
                    <span class="ha-flow-text"><strong>AI Screening</strong> — Claude analyzes resumes against your job requirements</span>
                </div>
                <div class="ha-flow-step">
                    <span class="ha-flow-num">3</span>
                    <span class="ha-flow-text"><strong>Assessments</strong> — Qualified candidates receive assessment invites</span>
                </div>
                <div class="ha-flow-step">
                    <span class="ha-flow-num">4</span>
                    <span class="ha-flow-text"><strong>AI Decision</strong> — Final recommendations based on all data</span>
                </div>
                <div class="ha-flow-step">
                    <span class="ha-flow-num">5</span>
                    <span class="ha-flow-text"><strong>Hire</strong> — Review and finalize your hiring decisions</span>
                </div>
            </div>

            {# Automation Modes #}
            <div class="ha-tip">
                <div class="ha-tip-header">
                    <div class="ha-tip-icon" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polyline></svg>
                    </div>
                    <h4 class="ha-tip-title">Automation Modes</h4>
                </div>
                <ul>
                    <li><strong>Recommend</strong> — AI recommends, you approve every step</li>
                    <li><strong>Semi-Auto</strong> — AI auto-screens, you approve assessments & decisions</li>
                    <li><strong>Full Auto</strong> — AI handles everything, you can intervene anytime</li>
                </ul>
            </div>

            {# Tips #}
            <div class="ha-tip">
                <div class="ha-tip-header">
                    <div class="ha-tip-icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    </div>
                    <h4 class="ha-tip-title">Tips</h4>
                </div>
                <ul>
                    <li>A detailed job description helps AI screen more accurately</li>
                    <li>List specific, measurable skills for better matching</li>
                    <li>Screening threshold of 60-70 works well for most roles</li>
                    <li>Resumes must contain an email address to be processed</li>
                </ul>
            </div>

        </aside>

    </div>

</div>

{% if not is_edit %}
<script>
(function() {
    var projectSelect = document.getElementById('id_project');
    if (!projectSelect) return;

    var levelMap = {
        'junior': 'junior', 'mid': 'mid', 'mid-level': 'mid',
        'senior': 'senior', 'lead': 'lead', 'executive': 'executive'
    };

    projectSelect.addEventListener('change', function() {
        var pid = this.value;
        if (!pid) return;

        fetch('{% url "hiring_agent:project-data" project_id=0 %}'.replace('/0/', '/' + pid + '/'))
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.error) return;
                var title = document.getElementById('id_title');
                var desc = document.getElementById('id_job_description');
                var reqSkills = document.getElementById('id_required_skills_text');
                var prefSkills = document.getElementById('id_preferred_skills_text');
                var seniority = document.getElementById('id_seniority_level');

                if (title && !title.value) title.value = data.title || '';
                if (desc && !desc.value) desc.value = data.job_description || '';
                if (reqSkills && !reqSkills.value) reqSkills.value = data.required_skills || '';
                if (prefSkills && !prefSkills.value) prefSkills.value = data.preferred_skills || '';
                if (seniority && data.role_level) {
                    var mapped = levelMap[data.role_level.toLowerCase().trim()];
                    if (mapped) seniority.value = mapped;
                }
            });
    });
})();
</script>
{% endif %}
{% endblock %}
