{% extends 'base.html' %}
{% load humanize %}
{% block body_class %}candidate-experience{% endblock %}
{% block content %}
<div class="candidate-shell single-column">
    <a class="candidate-skip-link" href="#questionForm">Skip to question content</a>
    <section class="candidate-panel response-panel question-step">
        <div class="question-progress" role="status" aria-live="polite" aria-label="Assessment progress">
            <div class="progress-meta">
                <span class="status-chip">
                    <span class="chip-dot"></span>
                    Assessment in progress
                </span>
            </div>
            <div class="progress-meter" role="img" aria-label="{{ progress_percent }}% complete">
                <div class="progress-bar">
                    <span style="width: {{ progress_percent }}%" aria-hidden="true"></span>
                </div>
            </div>
            <div class="progress-stats">
                <article class="progress-stat">
                    <span>Step</span>
                    <strong>{{ step_number }} / {{ total_steps }}</strong>
                </article>
                <article class="progress-stat">
                    <span>Complete</span>
                    <strong>{{ progress_percent }}%</strong>
                </article>
                {% if remaining_minutes %}
                <article class="progress-stat">
                    <span>Time left</span>
                    <strong>{{ remaining_minutes }} min</strong>
                </article>
                {% elif due_at %}
                <article class="progress-stat">
                    <span>Due</span>
                    <strong>{{ due_at|date:"M j, H:i" }}</strong>
                </article>
                {% endif %}
            </div>
        </div>
        <div class="session-utility-bar" role="status" aria-live="polite">
            <div>
                <p class="eyebrow">Progress saved</p>
                <strong>
                    {% if last_saved_at %}
                        {{ last_saved_at|naturaltime }}
                    {% else %}
                        Just now
                    {% endif %}
                </strong>
            </div>
            <form method="post" action="{{ pause_url }}">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline">Pause &amp; resume later</button>
            </form>
        </div>
        <div class="device-support" aria-labelledby="switchDeviceTitle" aria-describedby="switchHelp">
            <div>
                <p class="eyebrow" id="switchDeviceTitle">Switch device</p>
                <p>Need to continue on another laptop or tablet? We will email the secure link to <strong>{{ candidate.email }}</strong>.</p>
            </div>
            <form method="post" action="{{ switch_device_url }}">
                {% csrf_token %}
                <label class="sr-only" for="switch-email">Destination email</label>
                <input type="email" name="email" id="switch-email" value="{{ candidate.email }}" autocomplete="email" inputmode="email" required>
                <button type="submit" class="btn btn-ghost">Send link</button>
            </form>
        </div>
        <p class="input-hint" id="switchHelp">Enter a company or personal email to instantly receive your session link.</p>
        <div class="accessibility-hint" role="note">
            <strong>Keyboard &amp; contrast tips:</strong>
            <p>Use the Tab key to move between inputs, Shift + Tab to move backwards, and press the space bar to select options. Toggle dark or high-contrast mode at the top-right of the page if you need more visual separation.</p>
        </div>
        {% if help_topics %}
        <details class="help-drawer">
            <summary>
                <span>FAQ &amp; support</span>
                <span class="chevron" aria-hidden="true"></span>
            </summary>
            <div class="help-content">
                {% for topic in help_topics %}
                <article>
                    <strong>{{ topic.question }}</strong>
                    <p>{{ topic.answer }}</p>
                </article>
                {% endfor %}
                <p class="muted">Still need help? Email <a href="mailto:support@evalon.so">support@evalon.so</a> or <a href="{{ practice_url }}">try a practice question</a>.</p>
            </div>
        </details>
        {% endif %}
        <section class="support-center" aria-labelledby="supportCenterTitle">
            <div class="support-center-head">
                <div>
                    <p class="eyebrow" id="supportCenterTitle">Need more help?</p>
                    <h2>Contact our team without leaving the page.</h2>
                </div>
                <div class="support-actions">
                    <a class="pill" href="mailto:{{ support_contact_email }}">Email support</a>
                    <a class="pill subtle" href="tel:{{ support_contact_phone|cut:' ' }}">{{ support_contact_phone }}</a>
                </div>
            </div>
            <form method="post" action="{{ support_request_url }}" class="support-form">
                {% csrf_token %}
                <input type="hidden" name="action" value="support_request">
                <div class="support-form-grid">
                    <div class="form-field">
                        {{ support_form.topic.label_tag }}
                        {{ support_form.topic }}
                        {% for error in support_form.topic.errors %}
                        <span class="field-error">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="form-field">
                        {{ support_form.contact_method.label_tag }}
                        {{ support_form.contact_method }}
                        {% for error in support_form.contact_method.errors %}
                        <span class="field-error">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div class="form-field">
                        {{ support_form.contact_value.label_tag }}
                        {{ support_form.contact_value }}
                        {% for error in support_form.contact_value.errors %}
                        <span class="field-error">{{ error }}</span>
                        {% endfor %}
                    </div>
                </div>
                <div class="form-field">
                    {{ support_form.message.label_tag }}
                    {{ support_form.message }}
                    {% for error in support_form.message.errors %}
                    <span class="field-error">{{ error }}</span>
                    {% endfor %}
                </div>
                <div class="support-submit">
                    <button class="btn btn-ghost" type="submit">Send help request</button>
                    <p class="muted tiny">Weâ€™ll reply using your preferred channel within a few minutes.</p>
                </div>
            </form>
        </section>
        {% if instructions %}
        <div class="question-instructions">
            <p>{{ instructions }}</p>
        </div>
        {% endif %}
        {% if behavioral_focus_label %}
        <div class="focus-banner">
            <p><span>Behavioral focus:</span> {{ behavioral_focus_label }}</p>
        </div>
        {% endif %}
        <form method="post" class="question-form" id="questionForm">
            {% csrf_token %}
            <input type="hidden" name="telemetry_payload" data-telemetry-field>
            {% if form.non_field_errors %}
            <div class="form-error">
                {% for error in form.non_field_errors %}
                <p>{{ error }}</p>
                {% endfor %}
            </div>
            {% endif %}

            {% if question.question_type == 'behavioral' %}
            <div class="behavioral-set-card">
                <div class="behavioral-set-header">
                    <div>
                        <p class="eyebrow">Set {{ behavioral_block_index }} of {{ behavioral_total_blocks }}</p>
                        <h2>Select the statements that are most and least like you.</h2>
                        {% if guidance_tip %}
                        <div class="question-guidance">
                            <strong>{{ guidance_tip.title }}</strong>
                            <p>{{ guidance_tip.body }}</p>
                        </div>
                        {% endif %}
                        <p class="help-text">Choose one statement that best describes you and another that is least like you. Each choice must be different.</p>
                    </div>
                </div>
                <ul class="statement-list large">
                    {% for statement in behavioral_block.statements %}
                    <li>
                        <strong>{{ statement.id }}</strong>
                        <span>{{ statement.text }}</span>
                    </li>
                    {% endfor %}
                </ul>
                <div class="behavioral-inputs">
                    <div>
                        <label>{{ form.most_like.label }}</label>
                        {{ form.most_like }}
                        {% for error in form.most_like.errors %}
                        <span class="field-error">{{ error }}</span>
                        {% endfor %}
                    </div>
                    <div>
                        <label>{{ form.least_like.label }}</label>
                        {{ form.least_like }}
                        {% for error in form.least_like.errors %}
                        <span class="field-error">{{ error }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% else %}
            <div class="question-card">
                <p class="eyebrow">Question {{ question.order }}</p>
                <h2>{{ question.prompt }}</h2>
                {% if guidance_tip %}
                <div class="question-guidance">
                    <strong>{{ guidance_tip.title }}</strong>
                    <p>{{ guidance_tip.body }}</p>
                </div>
                {% endif %}
                <div class="question-input">
                    {% if question.question_type == 'text' %}
                        {{ form.response }}
                    {% elif question.question_type == 'multi' %}
                        <div class="option-list checkbox">
                            {% for option in form.response %}
                            <label class="option-item">{{ option.tag }} {{ option.choice_label }}</label>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="option-list">
                            {% for option in form.response %}
                            <label class="option-item">{{ option.tag }} {{ option.choice_label }}</label>
                            {% endfor %}
                        </div>
                    {% endif %}
                    {% for error in form.response.errors %}
                    <span class="field-error">{{ error }}</span>
                    {% endfor %}
                </div>
                {% if show_preview %}
                <div class="answer-preview">
                    <div class="preview-head">
                        <p class="eyebrow">Live preview</p>
                        <span class="char-count" data-char-count data-min-length="{{ preview_min_length }}">0 characters</span>
                    </div>
                    <p class="preview-hint">We autosave every few seconds. Aim for at least {{ preview_min_length }} characters with clear context, actions, and outcomes.</p>
                    <div class="preview-body" data-preview-body data-placeholder="Start typing to see your response preview."></div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <button type="submit" class="btn btn-pill">
                {% if step_number == total_steps %}Submit assessment{% else %}Save & Continue{% endif %}
            </button>
        </form>
    </section>
</div>
{% endblock %}
