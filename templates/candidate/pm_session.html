{% extends 'base.html' %}
{% load humanize %}
{% block content %}
<div class="candidate-shell single-column">
    <section class="candidate-panel response-panel question-step">
        <div class="question-progress">
            <div class="progress-meta">
                <span class="status-chip"><span class="chip-dot"></span>Product management assessment</span>
            </div>
            <div class="progress-meter">
                <div class="progress-bar">
                    <span style="width: {{ progress_percent }}%"></span>
                </div>
            </div>
            <div class="progress-stats">
                <article class="progress-stat">
                    <span>Step</span>
                    <strong>{{ step_number }} / {{ total_steps }}</strong>
                </article>
                <article class="progress-stat">
                    <span>Complete</span>
                    <strong>{{ progress_percent }}%</strong>
                </article>
                {% if remaining_minutes %}
                <article class="progress-stat">
                    <span>Time left</span>
                    <strong>{{ remaining_minutes }} min</strong>
                </article>
                {% endif %}
            </div>
        </div>
        <div class="session-utility-bar">
            <div>
                <p class="eyebrow">Progress saved</p>
                <strong>
                    {% if last_saved_at %}
                        {{ last_saved_at|naturaltime }}
                    {% else %}
                        Just now
                    {% endif %}
                </strong>
            </div>
            <form method="post" action="{{ pause_url }}">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline">Pause &amp; resume later</button>
            </form>
        </div>
        <div class="device-support">
            <div>
                <p class="eyebrow">Switch device</p>
                <p>Email yourself the secure link to continue on another laptop or tablet.</p>
            </div>
            <form method="post" action="{{ switch_device_url }}" class="device-form">
                {% csrf_token %}
                <input type="email" name="email" placeholder="you@company.com" required aria-label="Email address for the assessment link">
                <button type="submit" class="btn btn-ghost">Send link</button>
            </form>
        </div>
        {% if help_topics %}
        <details class="help-drawer">
            <summary>
                <span>FAQ &amp; support</span>
                <span class="chevron" aria-hidden="true"></span>
            </summary>
            <div class="help-content">
                {% for topic in help_topics %}
                <article>
                    <strong>{{ topic.question }}</strong>
                    <p>{{ topic.answer }}</p>
                </article>
                {% endfor %}
                <p class="muted">Questions? Email <a href="mailto:support@evalon.so">support@evalon.so</a> or practice first <a href="{{ practice_url }}">here</a>.</p>
            </div>
        </details>
        {% endif %}
        <form method="post" class="question-form">
            {% csrf_token %}
            <input type="hidden" name="telemetry_payload" data-telemetry-field>
            <div class="question-card">
                <p class="eyebrow">{{ question.get_category_display }}</p>
                <h2>{{ question.question_text }}</h2>
                {% if question.explanation %}
                <p class="help-text">{{ question.explanation }}</p>
                {% endif %}
                {% if guidance_tip %}
                <div class="question-guidance">
                    <strong>{{ guidance_tip.title }}</strong>
                    <p>{{ guidance_tip.body }}</p>
                </div>
                {% endif %}
                <div class="question-input">
                    {% if question.question_type == 'ranking' %}
                    <p class="help-text">Arrange the following items before submitting your final order:</p>
                    <ol class="ranking-items">
                        {% for item in form.ranking_items %}
                        <li>{{ item }}</li>
                        {% endfor %}
                    </ol>
                    {% elif question.question_type == 'behavioral_most' %}
                    <p class="help-text">Select the statement that is most like you.</p>
                    {% elif question.question_type == 'behavioral_least' %}
                    <p class="help-text">Select the statement that is least like you.</p>
                    {% endif %}
                    {% for field in form %}
                        {{ field }}
                        {% for error in field.errors %}
                        <span class="field-error">{{ error }}</span>
                        {% endfor %}
                    {% endfor %}
                </div>
                {% if show_preview %}
                <div class="answer-preview">
                    <div class="preview-head">
                        <p class="eyebrow">Live preview</p>
                        <span class="char-count" data-char-count data-min-length="{{ preview_min_length }}">0 characters</span>
                    </div>
                    <p class="preview-hint">We autosave your work. Aim for at least {{ preview_min_length }} characters covering assumptions, approach, and metrics.</p>
                    <div class="preview-body" data-preview-body data-placeholder="Start typing to see your response preview."></div>
                </div>
                {% endif %}
            </div>
            <button type="submit" class="btn btn-pill">
                {% if step_number == total_steps %}Submit assessment{% else %}Save & Continue{% endif %}
            </button>
        </form>
    </section>
</div>
{% endblock %}
